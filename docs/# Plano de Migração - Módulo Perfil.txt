# üë§ PLANO DE MIGRA√á√ÉO TDD - M√ìDULO PERFIL

## üéØ CONTEXTO

Migra√ß√£o do m√≥dulo de perfil de uma arquitetura baseada em localStorage para uma arquitetura de dados dual com **foco em experi√™ncia do usu√°rio e privacidade**, seguindo **metodologia TDD rigorosa** estabelecida na FASE 0:
- **Produ√ß√£o**: Supabase (PostgreSQL com RLS + Criptografia de dados pessoais)
- **Desenvolvimento/Testes**: Backend FastAPI local (SQLAlchemy + PostgreSQL local)
- **Metodologia**: Test-Driven Development (Red-Green-Refactor)
- **Infraestrutura**: Vitest + RTL + MSW + Quality Gates autom√°ticos
- **Foco**: UX/Acessibilidade + Privacidade + Personaliza√ß√£o + Performance

## üß™ PREPARA√á√ÉO TDD - INFRAESTRUTURA PRONTA

### ‚úÖ FASE 0 Conclu√≠da - Base S√≥lida Estabelecida

A **infraestrutura TDD robusta** j√° est√° 100% funcional:
- **Vitest**: Test runner otimizado (3x mais r√°pido que Jest)
- **React Testing Library**: Testes user-centric
- **MSW**: Mock Service Worker para APIs realistas
- **Quality Gates**: Coverage > 70% + Performance < 100ms
- **CI/CD Pipeline**: 7 jobs autom√°ticos com verifica√ß√µes rigorosas
- **Utilities**: Templates, factories, helpers prontos para uso

### üé® Extens√µes Espec√≠ficas para Dados de Perfil e UX

```typescript
// __tests__/utils/profile-validation.ts
export const validateProfileData = {
  nome: (nome: string) => nome.length >= 2 && nome.length <= 100 && !/[<>\"'&]/.test(nome),
  metasSono: (horas: number) => horas >= 4 && horas <= 12,
  metasTarefas: (tarefas: number) => tarefas >= 1 && tarefas <= 7,
  metasAgua: (copos: number) => copos >= 2 && copos <= 15,
  metasPausas: (pausas: number) => pausas >= 2 && pausas <= 10
}

export const sanitizeProfileData = {
  nome: (nome: string) => nome.trim().substring(0, 100).replace(/[<>\"'&]/g, ''),
  configuracoes: (config: any) => ({
    ...config,
    notificacoesAtivas: Boolean(config.notificacoesAtivas),
    pausasAtivas: Boolean(config.pausasAtivas)
  })
}

export const applyVisualPreferences = {
  altoContraste: (enabled: boolean) => {
    document.documentElement.classList.toggle('high-contrast', enabled)
  },
  reducaoEstimulos: (enabled: boolean) => {
    document.documentElement.classList.toggle('reduced-motion', enabled)
  },
  textoGrande: (enabled: boolean) => {
    document.documentElement.classList.toggle('large-text', enabled)
  }
}
```

---

## üìä 1. AN√ÅLISE DOS DADOS ATUAIS (localStorage)

### 1.1 Estrutura Atual no localStorage

**Chave: `perfil-storage`**
- **Dados**: Informa√ß√µes pessoais, prefer√™ncias visuais, metas di√°rias e configura√ß√µes
- **Estrutura**:
  ```json
  {
    "nome": "string",
    "preferenciasVisuais": {
      "altoContraste": "boolean",
      "reducaoEstimulos": "boolean",
      "textoGrande": "boolean"
    },
    "metasDiarias": {
      "horasSono": "number",
      "tarefasPrioritarias": "number",
      "coposAgua": "number",
      "pausasProgramadas": "number"
    },
    "notificacoesAtivas": "boolean",
    "pausasAtivas": "boolean"
  }
  ```

**Chave: `data-transfer-storage`**
- **Dados**: Status e hist√≥rico de transfer√™ncia de dados
- **Estrutura**:
  ```json
  {
    "status": "string",
    "mensagem": "string",
    "ultimaExportacao": "string | null",
    "ultimaImportacao": "string | null"
  }
  ```

### üß™ Factories TDD para Dados Existentes

```typescript
// __tests__/factories/perfil.ts
let profileCounter = 1
let transferCounter = 1

export const createUserProfile = (overrides = {}) => ({
  id: `profile-${profileCounter++}`,
  nome: 'Usu√°rio Teste',
  createdAt: new Date().toISOString(),
  updatedAt: new Date().toISOString(),
  ...overrides
})

export const createVisualPreferences = (overrides = {}) => ({
  id: `visual-${profileCounter++}`,
  altoContraste: false,
  reducaoEstimulos: false,
  textoGrande: false,
  ...overrides
})

export const createDailyGoals = (overrides = {}) => ({
  id: `goals-${profileCounter++}`,
  horasSono: 8,
  tarefasPrioritarias: 3,
  coposAgua: 8,
  pausasProgramadas: 4,
  ...overrides
})

export const createUserSettings = (overrides = {}) => ({
  id: `settings-${profileCounter++}`,
  notificacoesAtivas: true,
  pausasAtivas: true,
  ...overrides
})

export const createDataTransfer = (overrides = {}) => ({
  id: `transfer-${transferCounter++}`,
  tipo: 'exportacao',
  status: 'success',
  mensagem: 'Opera√ß√£o conclu√≠da com sucesso',
  createdAt: new Date().toISOString(),
  ...overrides
})
```

### Componentes Dependentes + Estrat√©gia de Testes

| Componente | Responsabilidade | Estrat√©gia TDD |
|------------|------------------|----------------|
| **InformacoesPessoais.tsx** | CRUD informa√ß√µes b√°sicas + valida√ß√£o | ‚úÖ Testes de Valida√ß√£o + Sanitiza√ß√£o |
| **PreferenciasVisuais.tsx** | Configura√ß√µes de acessibilidade | ‚úÖ Testes de Aplica√ß√£o + Performance |
| **MetasDiarias.tsx** | Defini√ß√£o de metas pessoais | ‚úÖ Testes de Ranges + UX |
| **ExportarImportarDados.tsx** | Transfer√™ncia de dados | ‚úÖ Testes de Privacidade + LGPD |
| **PerfilPage.tsx** | Orquestra√ß√£o geral | ‚úÖ Testes de Integra√ß√£o + E2E |

### üéØ Cobertura de Testes Planejada

```typescript
// Estrutura de testes para o m√≥dulo
__tests__/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ InformacoesPessoais.test.tsx     # CRUD + Valida√ß√£o + Sanitiza√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ PreferenciasVisuais.test.tsx     # Aplica√ß√£o + Performance + A11y
‚îÇ   ‚îú‚îÄ‚îÄ MetasDiarias.test.tsx            # Ranges + UX + Feedback
‚îÇ   ‚îú‚îÄ‚îÄ ExportarImportarDados.test.tsx   # Privacidade + LGPD + Seguran√ßa
‚îÇ   ‚îî‚îÄ‚îÄ PerfilPage.test.tsx              # Integra√ß√£o + E2E + Fluxos
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ usePerfil.test.ts                # Store + Mutations + Sync
‚îÇ   ‚îú‚îÄ‚îÄ useVisualPreferences.test.ts     # DOM manipulation + Performance
‚îÇ   ‚îú‚îÄ‚îÄ useDataTransfer.test.ts          # Export/Import + Privacy
‚îÇ   ‚îî‚îÄ‚îÄ useProfileSync.test.ts           # Cross-device sync + Conflicts
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ perfilApi.test.ts                # API calls + Privacy
‚îÇ   ‚îú‚îÄ‚îÄ visualPreferencesService.test.ts # DOM updates + Performance
‚îÇ   ‚îî‚îÄ‚îÄ dataExportService.test.ts        # LGPD compliance + Security
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ profileValidation.test.ts        # Validation utilities
‚îÇ   ‚îú‚îÄ‚îÄ privacyHelpers.test.ts           # Privacy protection
‚îÇ   ‚îî‚îÄ‚îÄ accessibilityHelpers.test.ts     # A11y utilities
‚îî‚îÄ‚îÄ integration/
    ‚îú‚îÄ‚îÄ perfil-flow.test.tsx             # E2E user scenarios
    ‚îú‚îÄ‚îÄ accessibility.test.tsx           # A11y compliance
    ‚îî‚îÄ‚îÄ privacy-compliance.test.tsx      # LGPD scenarios
```

---

## üóÑÔ∏è 2. ESQUEMA DE BANCO DE DADOS UNIFICADO (SQL)

```sql
-- Tabela de usu√°rios (base para autentica√ß√£o)
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP WITH TIME ZONE
);

-- Tabela de perfis de usu√°rio
CREATE TABLE user_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    nome VARCHAR(100) NOT NULL DEFAULT 'Usu√°rio',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id)
);

-- Tabela de prefer√™ncias visuais
CREATE TABLE user_visual_preferences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    alto_contraste BOOLEAN NOT NULL DEFAULT FALSE,
    reducao_estimulos BOOLEAN NOT NULL DEFAULT FALSE,
    texto_grande BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id)
);

-- Tabela de metas di√°rias
CREATE TABLE user_daily_goals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    horas_sono INTEGER NOT NULL DEFAULT 8 CHECK (horas_sono >= 4 AND horas_sono <= 12),
    tarefas_prioritarias INTEGER NOT NULL DEFAULT 3 CHECK (tarefas_prioritarias >= 1 AND tarefas_prioritarias <= 7),
    copos_agua INTEGER NOT NULL DEFAULT 8 CHECK (copos_agua >= 2 AND copos_agua <= 15),
    pausas_programadas INTEGER NOT NULL DEFAULT 4 CHECK (pausas_programadas >= 2 AND pausas_programadas <= 10),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id)
);

-- Tabela de configura√ß√µes gerais
CREATE TABLE user_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    notificacoes_ativas BOOLEAN NOT NULL DEFAULT TRUE,
    pausas_ativas BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id)
);

-- Tabela de log de transfer√™ncia de dados
CREATE TABLE user_data_transfers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    tipo VARCHAR(20) NOT NULL CHECK (tipo IN ('exportacao', 'importacao')),
    status VARCHAR(20) NOT NULL CHECK (status IN ('idle', 'exporting', 'importing', 'success', 'error')),
    mensagem TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- √çndices para performance
CREATE INDEX idx_user_profiles_user_id ON user_profiles(user_id);
CREATE INDEX idx_visual_preferences_user_id ON user_visual_preferences(user_id);
CREATE INDEX idx_daily_goals_user_id ON user_daily_goals(user_id);
CREATE INDEX idx_user_settings_user_id ON user_settings(user_id);
CREATE INDEX idx_data_transfers_user_id ON user_data_transfers(user_id);
CREATE INDEX idx_data_transfers_created_at ON user_data_transfers(created_at DESC);

-- Triggers para atualizar updated_at automaticamente
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_user_profiles_updated_at BEFORE UPDATE ON user_profiles FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_visual_preferences_updated_at BEFORE UPDATE ON user_visual_preferences FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_daily_goals_updated_at BEFORE UPDATE ON user_daily_goals FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_user_settings_updated_at BEFORE UPDATE ON user_settings FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

---

## üß™ 3. FACTORIES TDD ESPEC√çFICAS DO M√ìDULO

```typescript
// __tests__/factories/perfil.ts
import { faker } from '@faker-js/faker'

let profileCounter = 1
let transferCounter = 1

export const createCompleteProfile = (overrides = {}) => ({
  id: `profile-${profileCounter++}`,
  nome: faker.person.firstName(),
  preferenciasVisuais: {
    altoContraste: faker.datatype.boolean(),
    reducaoEstimulos: faker.datatype.boolean(),
    textoGrande: faker.datatype.boolean()
  },
  metasDiarias: {
    horasSono: faker.number.int({ min: 6, max: 10 }),
    tarefasPrioritarias: faker.number.int({ min: 2, max: 5 }),
    coposAgua: faker.number.int({ min: 6, max: 12 }),
    pausasProgramadas: faker.number.int({ min: 3, max: 6 })
  },
  configuracoes: {
    notificacoesAtivas: faker.datatype.boolean(),
    pausasAtivas: faker.datatype.boolean()
  },
  createdAt: faker.date.past().toISOString(),
  updatedAt: faker.date.recent().toISOString(),
  ...overrides
})

export const createUserProfile = (overrides = {}) => ({
  id: `user-${profileCounter++}`,
  nome: faker.helpers.arrayElement([
    'Jo√£o Silva', 'Maria Santos', 'Pedro Oliveira', 'Ana Costa', 'Carlos Ferreira'
  ]),
  email: faker.internet.email(),
  createdAt: faker.date.past().toISOString(),
  updatedAt: faker.date.recent().toISOString(),
  ...overrides
})

export const createVisualPreferences = (overrides = {}) => ({
  id: `visual-${profileCounter++}`,
  userId: `user-${faker.number.int({ min: 1, max: 5 })}`,
  altoContraste: faker.datatype.boolean(),
  reducaoEstimulos: faker.datatype.boolean(),
  textoGrande: faker.datatype.boolean(),
  createdAt: faker.date.past().toISOString(),
  updatedAt: faker.date.recent().toISOString(),
  ...overrides
})

export const createDailyGoals = (overrides = {}) => ({
  id: `goals-${profileCounter++}`,
  userId: `user-${faker.number.int({ min: 1, max: 5 })}`,
  horasSono: faker.number.int({ min: 4, max: 12 }),
  tarefasPrioritarias: faker.number.int({ min: 1, max: 7 }),
  coposAgua: faker.number.int({ min: 2, max: 15 }),
  pausasProgramadas: faker.number.int({ min: 2, max: 10 }),
  createdAt: faker.date.past().toISOString(),
  updatedAt: faker.date.recent().toISOString(),
  ...overrides
})

export const createUserSettings = (overrides = {}) => ({
  id: `settings-${profileCounter++}`,
  userId: `user-${faker.number.int({ min: 1, max: 5 })}`,
  notificacoesAtivas: faker.datatype.boolean(),
  pausasAtivas: faker.datatype.boolean(),
  createdAt: faker.date.past().toISOString(),
  updatedAt: faker.date.recent().toISOString(),
  ...overrides
})

export const createDataTransferLog = (overrides = {}) => ({
  id: `transfer-${transferCounter++}`,
  userId: `user-${faker.number.int({ min: 1, max: 5 })}`,
  tipo: faker.helpers.arrayElement(['exportacao', 'importacao']),
  status: faker.helpers.arrayElement(['idle', 'exporting', 'importing', 'success', 'error']),
  mensagem: faker.helpers.arrayElement([
    'Opera√ß√£o conclu√≠da com sucesso',
    'Dados exportados',
    'Importa√ß√£o realizada',
    'Erro na opera√ß√£o',
    'Processando...'
  ]),
  createdAt: faker.date.recent().toISOString(),
  ...overrides
})

// Utility para criar listas
export const createList = <T>(factory: () => T, count: number, overrides: Partial<T>[] = []): T[] => {
  return Array.from({ length: count }, (_, index) => ({
    ...factory(),
    ...overrides[index]
  }))
}

// Factories para cen√°rios espec√≠ficos
export const createAccessibilityProfile = (overrides = {}) => createCompleteProfile({
  preferenciasVisuais: {
    altoContraste: true,
    reducaoEstimulos: true,
    textoGrande: true
  },
  ...overrides
})

export const createMinimalProfile = (overrides = {}) => createCompleteProfile({
  nome: 'Usu√°rio',
  preferenciasVisuais: {
    altoContraste: false,
    reducaoEstimulos: false,
    textoGrande: false
  },
  metasDiarias: {
    horasSono: 8,
    tarefasPrioritarias: 3,
    coposAgua: 8,
    pausasProgramadas: 4
  },
  configuracoes: {
    notificacoesAtivas: true,
    pausasAtivas: true
  },
  ...overrides
})
```

---

## üåê 4. CONTRATO DE API (OpenAPI/Swagger Simplificado)

### Autentica√ß√£o
```markdown
POST /auth/login
POST /auth/logout
GET /auth/profile
```

### Endpoints do Perfil

#### **GET /api/v1/profile**
**Descri√ß√£o:** Obter perfil completo do usu√°rio

**Headers:**
```json
{
  "Authorization": "Bearer <token>",
  "Content-Type": "application/json"
}
```

**Resposta de Sucesso (200):**
```json
{
  "success": true,
  "data": {
    "nome": "Jo√£o Silva",
    "preferenciasVisuais": {
      "altoContraste": false,
      "reducaoEstimulos": true,
      "textoGrande": false
    },
    "metasDiarias": {
      "horasSono": 8,
      "tarefasPrioritarias": 3,
      "coposAgua": 8,
      "pausasProgramadas": 4
    },
    "configuracoes": {
      "notificacoesAtivas": true,
      "pausasAtivas": true
    },
    "updatedAt": "2024-01-15T10:30:00Z"
  }
}
```

**C√≥digos de Erro:**
- `401`: N√£o autorizado
- `404`: Perfil n√£o encontrado
- `500`: Erro interno do servidor

---

#### **PUT /api/v1/profile/basic-info**
**Descri√ß√£o:** Atualizar informa√ß√µes b√°sicas do perfil

**Payload da Requisi√ß√£o:**
```json
{
  "nome": "Jo√£o Silva Atualizado"
}
```

**Resposta de Sucesso (200):**
```json
{
  "success": true,
  "message": "Informa√ß√µes b√°sicas atualizadas com sucesso",
  "data": {
    "nome": "Jo√£o Silva Atualizado",
    "updatedAt": "2024-01-15T10:35:00Z"
  }
}
```

**C√≥digos de Erro:**
- `400`: Dados inv√°lidos (nome muito longo, etc.)
- `401`: N√£o autorizado
- `422`: Valida√ß√£o falhou

---

#### **PUT /api/v1/profile/visual-preferences**
**Descri√ß√£o:** Atualizar prefer√™ncias visuais

**Payload da Requisi√ß√£o:**
```json
{
  "altoContraste": true,
  "reducaoEstimulos": false,
  "textoGrande": true
}
```

**Resposta de Sucesso (200):**
```json
{
  "success": true,
  "message": "Prefer√™ncias visuais atualizadas com sucesso",
  "data": {
    "preferenciasVisuais": {
      "altoContraste": true,
      "reducaoEstimulos": false,
      "textoGrande": true
    },
    "updatedAt": "2024-01-15T10:40:00Z"
  }
}
```

---

#### **PUT /api/v1/profile/daily-goals**
**Descri√ß√£o:** Atualizar metas di√°rias

**Payload da Requisi√ß√£o:**
```json
{
  "horasSono": 9,
  "tarefasPrioritarias": 4,
  "coposAgua": 10,
  "pausasProgramadas": 5
}
```

**Valida√ß√µes:**
- `horasSono`: 4-12
- `tarefasPrioritarias`: 1-7
- `coposAgua`: 2-15
- `pausasProgramadas`: 2-10

**Resposta de Sucesso (200):**
```json
{
  "success": true,
  "message": "Metas di√°rias atualizadas com sucesso",
  "data": {
    "metasDiarias": {
      "horasSono": 9,
      "tarefasPrioritarias": 4,
      "coposAgua": 10,
      "pausasProgramadas": 5
    },
    "updatedAt": "2024-01-15T10:45:00Z"
  }
}
```

---

#### **PUT /api/v1/profile/settings**
**Descri√ß√£o:** Atualizar configura√ß√µes gerais

**Payload da Requisi√ß√£o:**
```json
{
  "notificacoesAtivas": false,
  "pausasAtivas": true
}
```

**Resposta de Sucesso (200):**
```json
{
  "success": true,
  "message": "Configura√ß√µes atualizadas com sucesso",
  "data": {
    "configuracoes": {
      "notificacoesAtivas": false,
      "pausasAtivas": true
    },
    "updatedAt": "2024-01-15T10:50:00Z"
  }
}
```

---

#### **POST /api/v1/profile/reset**
**Descri√ß√£o:** Resetar perfil para valores padr√£o

**Resposta de Sucesso (200):**
```json
{
  "success": true,
  "message": "Perfil resetado para valores padr√£o",
  "data": {
    "nome": "Usu√°rio",
    "preferenciasVisuais": {
      "altoContraste": false,
      "reducaoEstimulos": false,
      "textoGrande": false
    },
    "metasDiarias": {
      "horasSono": 8,
      "tarefasPrioritarias": 3,
      "coposAgua": 8,
      "pausasProgramadas": 4
    },
    "configuracoes": {
      "notificacoesAtivas": true,
      "pausasAtivas": true
    },
    "updatedAt": "2024-01-15T10:55:00Z"
  }
}
```

---

### Endpoints de Transfer√™ncia de Dados

#### **GET /api/v1/data-transfer/history**
**Descri√ß√£o:** Obter hist√≥rico de transfer√™ncias

**Resposta de Sucesso (200):**
```json
{
  "success": true,
  "data": {
    "ultimaExportacao": "2024-01-15T09:30:00Z",
    "ultimaImportacao": "2024-01-14T15:20:00Z",
    "historico": [
      {
        "tipo": "exportacao",
        "status": "success",
        "mensagem": "Dados exportados com sucesso",
        "createdAt": "2024-01-15T09:30:00Z"
      }
    ]
  }
}
```

#### **POST /api/v1/data-transfer/log**
**Descri√ß√£o:** Registrar evento de transfer√™ncia

**Payload da Requisi√ß√£o:**
```json
{
  "tipo": "exportacao",
  "status": "success",
  "mensagem": "Dados exportados com sucesso"
}
```

---

## üß™ 5. TEMPLATES DE TESTE ESPEC√çFICOS DO M√ìDULO

### 5.1 Testes de Componentes de Perfil

```typescript
// __tests__/components/InformacoesPessoais.test.tsx
import { render, screen, waitFor } from '@/test-utils'
import userEvent from '@testing-library/user-event'
import { vi } from 'vitest'
import { InformacoesPessoais } from '@/components/perfil/InformacoesPessoais'
import { createUserProfile } from '@/factories/perfil'

describe('InformacoesPessoais', () => {
  const defaultProps = {
    profile: createUserProfile(),
    onSave: vi.fn(),
    onCancel: vi.fn(),
  }

  const renderComponent = (props = {}) => {
    return render(<InformacoesPessoais {...defaultProps} {...props} />)
  }

  beforeEach(() => {
    vi.clearAllMocks()
  })

  describe('üî¥ RED: Valida√ß√£o de Dados Pessoais', () => {
    it('deve validar nome obrigat√≥rio', async () => {
      const user = userEvent.setup()
      renderComponent()

      const nomeInput = screen.getByLabelText(/nome/i)
      await user.clear(nomeInput)
      await user.click(screen.getByRole('button', { name: /salvar/i }))

      expect(screen.getByText(/nome √© obrigat√≥rio/i)).toBeInTheDocument()
      expect(defaultProps.onSave).not.toHaveBeenCalled()
    })

    it('deve validar tamanho m√≠nimo do nome', async () => {
      const user = userEvent.setup()
      renderComponent()

      const nomeInput = screen.getByLabelText(/nome/i)
      await user.clear(nomeInput)
      await user.type(nomeInput, 'A')
      await user.click(screen.getByRole('button', { name: /salvar/i }))

      expect(screen.getByText(/nome deve ter pelo menos 2 caracteres/i)).toBeInTheDocument()
    })

    it('deve validar tamanho m√°ximo do nome', async () => {
      const user = userEvent.setup()
      renderComponent()

      const nomeInput = screen.getByLabelText(/nome/i)
      await user.clear(nomeInput)
      await user.type(nomeInput, 'A'.repeat(101))
      await user.click(screen.getByRole('button', { name: /salvar/i }))

      expect(screen.getByText(/nome n√£o pode exceder 100 caracteres/i)).toBeInTheDocument()
    })

    it('deve sanitizar caracteres perigosos', async () => {
      const user = userEvent.setup()
      renderComponent()

      const nomeInput = screen.getByLabelText(/nome/i)
      await user.clear(nomeInput)
      await user.type(nomeInput, 'Jo√£o<script>alert("xss")</script>')
      await user.click(screen.getByRole('button', { name: /salvar/i }))

      expect(defaultProps.onSave).toHaveBeenCalledWith(
        expect.objectContaining({
          nome: 'Jo√£oscriptalert("xss")/script'
        })
      )
    })
  })

  describe('üü¢ GREEN: Funcionalidade B√°sica', () => {
    it('deve salvar informa√ß√µes v√°lidas', async () => {
      const user = userEvent.setup()
      renderComponent()

      const nomeInput = screen.getByLabelText(/nome/i)
      await user.clear(nomeInput)
      await user.type(nomeInput, 'Jo√£o Silva')
      await user.click(screen.getByRole('button', { name: /salvar/i }))

      expect(defaultProps.onSave).toHaveBeenCalledWith(
        expect.objectContaining({
          nome: 'Jo√£o Silva'
        })
      )
    })

    it('deve mostrar feedback de loading durante salvamento', async () => {
      const user = userEvent.setup()
      renderComponent({ isLoading: true })

      expect(screen.getByRole('button', { name: /salvando/i })).toBeDisabled()
      expect(screen.getByTestId('loading-spinner')).toBeInTheDocument()
    })
  })

  describe('üîµ REFACTOR: Acessibilidade e UX', () => {
    it('deve ter labels apropriados para leitores de tela', () => {
      renderComponent()

      expect(screen.getByLabelText(/nome completo/i)).toBeInTheDocument()
      expect(screen.getByRole('button', { name: /salvar informa√ß√µes pessoais/i })).toBeInTheDocument()
    })

    it('deve anunciar erros para leitores de tela', async () => {
      const user = userEvent.setup()
      renderComponent()

      await user.click(screen.getByRole('button', { name: /salvar/i }))

      const errorMessage = screen.getByText(/nome √© obrigat√≥rio/i)
      expect(errorMessage).toHaveAttribute('role', 'alert')
      expect(errorMessage).toHaveAttribute('aria-live', 'polite')
    })

    it('deve focar no primeiro campo com erro', async () => {
      const user = userEvent.setup()
      renderComponent()

      await user.click(screen.getByRole('button', { name: /salvar/i }))

      await waitFor(() => {
        expect(screen.getByLabelText(/nome/i)).toHaveFocus()
      })
    })
  })
})
```

### 5.2 Testes de Prefer√™ncias Visuais

```typescript
// __tests__/components/PreferenciasVisuais.test.tsx
import { render, screen, waitFor } from '@/test-utils'
import userEvent from '@testing-library/user-event'
import { vi } from 'vitest'
import { PreferenciasVisuais } from '@/components/perfil/PreferenciasVisuais'
import { createVisualPreferences } from '@/factories/perfil'

describe('PreferenciasVisuais', () => {
  const defaultProps = {
    preferences: createVisualPreferences(),
    onUpdate: vi.fn(),
  }

  beforeEach(() => {
    vi.clearAllMocks()
    // Reset DOM classes
    document.documentElement.className = ''
  })

  describe('üî¥ RED: Aplica√ß√£o de Prefer√™ncias', () => {
    it('deve aplicar alto contraste imediatamente', async () => {
      const user = userEvent.setup()
      render(<PreferenciasVisuais {...defaultProps} />)

      const altoContrasteToggle = screen.getByRole('switch', { name: /alto contraste/i })
      await user.click(altoContrasteToggle)

      expect(document.documentElement).toHaveClass('high-contrast')
      expect(defaultProps.onUpdate).toHaveBeenCalledWith(
        expect.objectContaining({ altoContraste: true })
      )
    })

    it('deve aplicar redu√ß√£o de est√≠mulos', async () => {
      const user = userEvent.setup()
      render(<PreferenciasVisuais {...defaultProps} />)

      const reducaoEstimulosToggle = screen.getByRole('switch', { name: /redu√ß√£o de est√≠mulos/i })
      await user.click(reducaoEstimulosToggle)

      expect(document.documentElement).toHaveClass('reduced-motion')
    })

    it('deve aplicar texto grande', async () => {
      const user = userEvent.setup()
      render(<PreferenciasVisuais {...defaultProps} />)

      const textoGrandeToggle = screen.getByRole('switch', { name: /texto grande/i })
      await user.click(textoGrandeToggle)

      expect(document.documentElement).toHaveClass('large-text')
    })
  })

  describe('üü¢ GREEN: Performance de Aplica√ß√£o', () => {
    it('deve aplicar prefer√™ncias em menos de 100ms', async () => {
      const user = userEvent.setup()
      render(<PreferenciasVisuais {...defaultProps} />)

      const startTime = performance.now()

      const altoContrasteToggle = screen.getByRole('switch', { name: /alto contraste/i })
      await user.click(altoContrasteToggle)

      const endTime = performance.now()
      expect(endTime - startTime).toBeLessThan(100)
    })

    it('deve persistir prefer√™ncias entre renderiza√ß√µes', () => {
      const preferences = createVisualPreferences({
        altoContraste: true,
        textoGrande: true
      })

      render(<PreferenciasVisuais {...defaultProps} preferences={preferences} />)

      expect(document.documentElement).toHaveClass('high-contrast')
      expect(document.documentElement).toHaveClass('large-text')
    })
  })

  describe('üîµ REFACTOR: Acessibilidade Avan√ßada', () => {
    it('deve ter descri√ß√µes adequadas para cada prefer√™ncia', () => {
      render(<PreferenciasVisuais {...defaultProps} />)

      expect(screen.getByText(/melhora a legibilidade com cores contrastantes/i)).toBeInTheDocument()
      expect(screen.getByText(/reduz anima√ß√µes e movimentos/i)).toBeInTheDocument()
      expect(screen.getByText(/aumenta o tamanho do texto/i)).toBeInTheDocument()
    })

    it('deve anunciar mudan√ßas para leitores de tela', async () => {
      const user = userEvent.setup()
      render(<PreferenciasVisuais {...defaultProps} />)

      const altoContrasteToggle = screen.getByRole('switch', { name: /alto contraste/i })
      await user.click(altoContrasteToggle)

      await waitFor(() => {
        expect(screen.getByText(/alto contraste ativado/i)).toHaveAttribute('aria-live', 'polite')
      })
    })

    it('deve permitir navega√ß√£o por teclado', async () => {
      render(<PreferenciasVisuais {...defaultProps} />)

      const firstToggle = screen.getAllByRole('switch')[0]
      firstToggle.focus()

      expect(firstToggle).toHaveFocus()

      // Simular Tab para pr√≥ximo elemento
      await userEvent.keyboard('{Tab}')
      expect(screen.getAllByRole('switch')[1]).toHaveFocus()
    })
  })
})
```

---

## üé≠ 6. MSW HANDLERS PARA APIS DE PERFIL

```typescript
// __tests__/mocks/handlers/perfil.ts
import { http, HttpResponse } from 'msw'
import { createCompleteProfile, createUserProfile, createDataTransferLog } from '@/factories/perfil'

export const perfilHandlers = [
  // Perfil Completo
  http.get('/api/v1/profile', ({ request }) => {
    const url = new URL(request.url)
    const userId = url.searchParams.get('userId')

    if (!userId) {
      return new HttpResponse(null, { status: 401 })
    }

    return HttpResponse.json({
      success: true,
      data: createCompleteProfile({ userId })
    })
  }),

  // Informa√ß√µes B√°sicas
  http.put('/api/v1/profile/basic-info', async ({ request }) => {
    const updates = await request.json()

    // Valida√ß√£o de nome
    if (!updates.nome || updates.nome.length < 2) {
      return HttpResponse.json(
        {
          success: false,
          error: 'Nome deve ter pelo menos 2 caracteres'
        },
        { status: 400 }
      )
    }

    if (updates.nome.length > 100) {
      return HttpResponse.json(
        {
          success: false,
          error: 'Nome n√£o pode exceder 100 caracteres'
        },
        { status: 400 }
      )
    }

    // Sanitiza√ß√£o
    const sanitizedNome = updates.nome.replace(/[<>\"'&]/g, '')

    return HttpResponse.json({
      success: true,
      message: 'Informa√ß√µes b√°sicas atualizadas com sucesso',
      data: {
        nome: sanitizedNome,
        updatedAt: new Date().toISOString()
      }
    })
  }),

  // Prefer√™ncias Visuais
  http.put('/api/v1/profile/visual-preferences', async ({ request }) => {
    const preferences = await request.json()

    // Valida√ß√£o de tipos
    const validatedPreferences = {
      altoContraste: Boolean(preferences.altoContraste),
      reducaoEstimulos: Boolean(preferences.reducaoEstimulos),
      textoGrande: Boolean(preferences.textoGrande)
    }

    return HttpResponse.json({
      success: true,
      message: 'Prefer√™ncias visuais atualizadas com sucesso',
      data: {
        preferenciasVisuais: validatedPreferences,
        updatedAt: new Date().toISOString()
      }
    })
  }),

  // Metas Di√°rias
  http.put('/api/v1/profile/daily-goals', async ({ request }) => {
    const goals = await request.json()

    // Valida√ß√µes de range
    const errors = []
    if (goals.horasSono < 4 || goals.horasSono > 12) {
      errors.push('Horas de sono deve estar entre 4 e 12')
    }
    if (goals.tarefasPrioritarias < 1 || goals.tarefasPrioritarias > 7) {
      errors.push('Tarefas priorit√°rias deve estar entre 1 e 7')
    }
    if (goals.coposAgua < 2 || goals.coposAgua > 15) {
      errors.push('Copos de √°gua deve estar entre 2 e 15')
    }
    if (goals.pausasProgramadas < 2 || goals.pausasProgramadas > 10) {
      errors.push('Pausas programadas deve estar entre 2 e 10')
    }

    if (errors.length > 0) {
      return HttpResponse.json(
        {
          success: false,
          errors
        },
        { status: 400 }
      )
    }

    return HttpResponse.json({
      success: true,
      message: 'Metas di√°rias atualizadas com sucesso',
      data: {
        metasDiarias: goals,
        updatedAt: new Date().toISOString()
      }
    })
  }),

  // Configura√ß√µes
  http.put('/api/v1/profile/settings', async ({ request }) => {
    const settings = await request.json()

    const validatedSettings = {
      notificacoesAtivas: Boolean(settings.notificacoesAtivas),
      pausasAtivas: Boolean(settings.pausasAtivas)
    }

    return HttpResponse.json({
      success: true,
      message: 'Configura√ß√µes atualizadas com sucesso',
      data: {
        configuracoes: validatedSettings,
        updatedAt: new Date().toISOString()
      }
    })
  }),

  // Reset do Perfil
  http.post('/api/v1/profile/reset', () => {
    return HttpResponse.json({
      success: true,
      message: 'Perfil resetado para valores padr√£o',
      data: createCompleteProfile({
        nome: 'Usu√°rio',
        preferenciasVisuais: {
          altoContraste: false,
          reducaoEstimulos: false,
          textoGrande: false
        },
        metasDiarias: {
          horasSono: 8,
          tarefasPrioritarias: 3,
          coposAgua: 8,
          pausasProgramadas: 4
        },
        configuracoes: {
          notificacoesAtivas: true,
          pausasAtivas: true
        }
      })
    })
  }),

  // Transfer√™ncia de Dados
  http.get('/api/v1/data-transfer/history', () => {
    return HttpResponse.json({
      success: true,
      data: {
        ultimaExportacao: new Date(Date.now() - 86400000).toISOString(),
        ultimaImportacao: new Date(Date.now() - 172800000).toISOString(),
        historico: [
          createDataTransferLog({ tipo: 'exportacao', status: 'success' }),
          createDataTransferLog({ tipo: 'importacao', status: 'success' }),
          createDataTransferLog({ tipo: 'exportacao', status: 'error' })
        ]
      }
    })
  }),

  http.post('/api/v1/data-transfer/log', async ({ request }) => {
    const logData = await request.json()

    if (!['exportacao', 'importacao'].includes(logData.tipo)) {
      return HttpResponse.json(
        { error: 'Tipo inv√°lido' },
        { status: 400 }
      )
    }

    return HttpResponse.json(
      createDataTransferLog(logData),
      { status: 201 }
    )
  }),

  // Cen√°rios de Erro para Testes
  http.get('/api/v1/profile/error', () => {
    return new HttpResponse(null, { status: 500 })
  }),

  http.put('/api/v1/profile/timeout', () => {
    return new Promise(() => {}) // Never resolves (timeout)
  }),

  // Cen√°rios de Seguran√ßa
  http.put('/api/v1/profile/security-test', async ({ request }) => {
    const data = await request.json()

    // Simular tentativa de XSS
    if (data.nome && data.nome.includes('<script>')) {
      return HttpResponse.json(
        { error: 'Dados maliciosos detectados' },
        { status: 400 }
      )
    }

    return HttpResponse.json({
      success: true,
      data: createUserProfile(data)
    })
  })
]
```

---

## üöÄ 7. PLANO DE MIGRA√á√ÉO TDD DUAL-TRACK (M√âTODO MOSCOW)

### **MUST HAVE (Cr√≠tico + TDD Rigoroso)**

#### üî¥ RED ‚Üí üü¢ GREEN ‚Üí üîµ REFACTOR

1. **[TDD Backend]** Testes de autentica√ß√£o JWT ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
2. **[TDD Backend]** Testes APIs profile/preferences/goals/settings ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
3. **[TDD Frontend]** Testes service layer ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
4. **[TDD Frontend]** Testes fallback localStorage ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
5. **[TDD Database]** Testes schema + migrations ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o

**Quality Gate**: ‚úÖ Coverage > 70% + Todos os testes passando antes de prosseguir

### **SHOULD HAVE (TDD + Experi√™ncia Completa)**

6. **[TDD Frontend]** Testes aplica√ß√£o prefer√™ncias visuais ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
7. **[TDD Frontend]** Testes migra√ß√£o stores ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
8. **[TDD Frontend]** Testes sync offline/online ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
9. **[TDD Database]** Testes RLS Supabase ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
10. **[TDD Migration]** Testes script migra√ß√£o ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o

**Quality Gate**: ‚úÖ Coverage > 75% + Performance < 100ms + Zero bugs cr√≠ticos

### **COULD HAVE (TDD + Otimiza√ß√£o)**

11. **[TDD Frontend]** Testes acessibilidade avan√ßada ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
12. **[TDD Frontend]** Testes optimistic updates ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
13. **[TDD Frontend]** Testes backup/restore ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
14. **[TDD Privacy]** Testes LGPD compliance ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
15. **[TDD Performance]** Testes aplica√ß√£o instant√¢nea ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o

**Quality Gate**: ‚úÖ Coverage > 80% + Performance < 50ms + Compliance 100%

### **WON'T HAVE (N√£o implementar nesta itera√ß√£o)**

16. **[Features]** Sincroniza√ß√£o de prefer√™ncias entre m√∫ltiplos usu√°rios
17. **[Features]** An√°lise de padr√µes de uso com IA
18. **[Infrastructure]** Deploy automatizado com CI/CD (j√° configurado na FASE 0)
19. **[Features]** Integra√ß√£o com sistemas externos de acessibilidade
20. **[Features]** Backup autom√°tico em nuvem

---

## üîß CHECKLIST DE IMPLEMENTA√á√ÉO TDD

### **Fase 1: Prepara√ß√£o TDD (Must Have)**
- [ ] üî¥ Escrever testes de autentica√ß√£o JWT ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Escrever testes RLS Supabase ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Escrever testes schema BD ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Escrever testes service layer ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Escrever testes env config ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] ‚úÖ **Quality Gate**: Coverage > 70% + Todos os testes passando

### **Fase 2: APIs Core TDD (Must Have + Should Have)**
- [ ] üî¥ Testes CRUD profile basic-info ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes CRUD visual-preferences ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes CRUD daily-goals ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes CRUD settings ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes data-transfer APIs ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] ‚úÖ **Quality Gate**: Coverage > 75% + Performance < 100ms

### **Fase 3: Migra√ß√£o Frontend TDD (Should Have)**
- [ ] üî¥ Testes InformacoesPessoais ‚Üí üü¢ Migrar APIs ‚Üí üîµ Refatorar
- [ ] üî¥ Testes PreferenciasVisuais ‚Üí üü¢ Migrar APIs ‚Üí üîµ Refatorar
- [ ] üî¥ Testes MetasDiarias ‚Üí üü¢ Migrar APIs ‚Üí üîµ Refatorar
- [ ] üî¥ Testes ExportarImportarDados ‚Üí üü¢ Migrar APIs ‚Üí üîµ Refatorar
- [ ] üî¥ Testes sincroniza√ß√£o ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] ‚úÖ **Quality Gate**: Coverage > 80% + Zero bugs cr√≠ticos

### **Fase 4: Script Migra√ß√£o TDD (Should Have)**
- [ ] üî¥ Testes export localStorage ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes import BD ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes migra√ß√£o real ‚Üí üü¢ Executar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes rollback ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] ‚úÖ **Quality Gate**: 100% dados migrados + Zero perda

### **Fase 5: Otimiza√ß√µes TDD (Could Have)**
- [ ] üî¥ Testes acessibilidade ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes performance UX ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes LGPD compliance ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes aplica√ß√£o instant√¢nea ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] ‚úÖ **Quality Gate**: Coverage > 85% + Performance < 50ms

---

## üîí 8. QUALITY GATES ESPEC√çFICOS PARA DADOS PESSOAIS

### 8.1 Valida√ß√µes de Privacidade e UX

```typescript
// __tests__/utils/profile-quality-gates.ts
export const profileQualityGates = {
  // Valida√ß√£o de dados pessoais
  validatePersonalData: (nome: string): boolean => {
    const nomeRegex = /^[a-zA-Z√Ä-√ø\s]{2,100}$/
    return nomeRegex.test(nome) && !/<[^>]*>/.test(nome)
  },

  // Valida√ß√£o de metas di√°rias
  validateDailyGoals: (goals: any): string[] => {
    const errors: string[] = []

    if (goals.horasSono < 4 || goals.horasSono > 12) {
      errors.push('Horas de sono deve estar entre 4 e 12')
    }
    if (goals.tarefasPrioritarias < 1 || goals.tarefasPrioritarias > 7) {
      errors.push('Tarefas priorit√°rias deve estar entre 1 e 7')
    }
    if (goals.coposAgua < 2 || goals.coposAgua > 15) {
      errors.push('Copos de √°gua deve estar entre 2 e 15')
    }
    if (goals.pausasProgramadas < 2 || goals.pausasProgramadas > 10) {
      errors.push('Pausas programadas deve estar entre 2 e 10')
    }

    return errors
  },

  // Performance de aplica√ß√£o de prefer√™ncias visuais
  validateVisualPreferencesPerformance: async (applyFunction: Function): Promise<boolean> => {
    const startTime = performance.now()
    await applyFunction()
    const endTime = performance.now()
    return (endTime - startTime) < 100 // Menos de 100ms
  },

  // Sanitiza√ß√£o de dados pessoais
  sanitizePersonalData: (data: any) => ({
    ...data,
    nome: data.nome?.trim().substring(0, 100).replace(/[<>\"'&]/g, ''),
    configuracoes: {
      notificacoesAtivas: Boolean(data.configuracoes?.notificacoesAtivas),
      pausasAtivas: Boolean(data.configuracoes?.pausasAtivas)
    }
  }),

  // Verifica√ß√£o de compliance LGPD
  validateLGPDCompliance: (userData: any): boolean => {
    // Verificar se dados sens√≠veis est√£o criptografados
    // Verificar se h√° consentimento para processamento
    // Verificar se dados podem ser exportados/deletados
    return true // Implementa√ß√£o espec√≠fica
  }
}

// Testes dos Quality Gates
describe('Profile Quality Gates', () => {
  describe('Personal Data Validation', () => {
    it('deve aceitar nomes v√°lidos', () => {
      const validNames = ['Jo√£o Silva', 'Maria Jos√©', 'Pedro Oliveira Santos']

      validNames.forEach(nome => {
        expect(profileQualityGates.validatePersonalData(nome)).toBe(true)
      })
    })

    it('deve rejeitar nomes inv√°lidos', () => {
      const invalidNames = ['A', 'A'.repeat(101), 'Jo√£o<script>', '']

      invalidNames.forEach(nome => {
        expect(profileQualityGates.validatePersonalData(nome)).toBe(false)
      })
    })
  })

  describe('Daily Goals Validation', () => {
    it('deve validar metas dentro dos ranges', () => {
      const validGoals = {
        horasSono: 8,
        tarefasPrioritarias: 3,
        coposAgua: 8,
        pausasProgramadas: 4
      }

      const errors = profileQualityGates.validateDailyGoals(validGoals)
      expect(errors).toHaveLength(0)
    })

    it('deve detectar metas fora dos ranges', () => {
      const invalidGoals = {
        horasSono: 15, // Muito alto
        tarefasPrioritarias: 0, // Muito baixo
        coposAgua: 20, // Muito alto
        pausasProgramadas: 1 // Muito baixo
      }

      const errors = profileQualityGates.validateDailyGoals(invalidGoals)
      expect(errors).toHaveLength(4)
    })
  })

  describe('Visual Preferences Performance', () => {
    it('deve aplicar prefer√™ncias em menos de 100ms', async () => {
      const mockApplyFunction = vi.fn().mockResolvedValue(undefined)

      const isPerformant = await profileQualityGates.validateVisualPreferencesPerformance(mockApplyFunction)

      expect(isPerformant).toBe(true)
      expect(mockApplyFunction).toHaveBeenCalled()
    })
  })

  describe('Data Sanitization', () => {
    it('deve sanitizar dados pessoais', () => {
      const dirtyData = {
        nome: '  Jo√£o<script>alert("xss")</script>  ',
        configuracoes: {
          notificacoesAtivas: 'true',
          pausasAtivas: 1
        }
      }

      const sanitized = profileQualityGates.sanitizePersonalData(dirtyData)

      expect(sanitized.nome).toBe('Jo√£oscriptalert("xss")/script')
      expect(sanitized.configuracoes.notificacoesAtivas).toBe(true)
      expect(sanitized.configuracoes.pausasAtivas).toBe(true)
    })
  })
})
```

### **Fase 1: Prepara√ß√£o (1-2 dias)**

### 8.2 Testes de Acessibilidade e UX

```typescript
// __tests__/accessibility/profile-accessibility.test.ts
describe('Profile Accessibility', () => {
  describe('Visual Preferences Application', () => {
    it('deve aplicar alto contraste corretamente', async () => {
      const { applyVisualPreferences } = await import('@/utils/accessibility')

      applyVisualPreferences.altoContraste(true)

      expect(document.documentElement).toHaveClass('high-contrast')

      // Verificar se cores contrastantes est√£o sendo aplicadas
      const computedStyle = getComputedStyle(document.documentElement)
      expect(computedStyle.getPropertyValue('--bg-color')).toBe('#000000')
      expect(computedStyle.getPropertyValue('--text-color')).toBe('#ffffff')
    })

    it('deve aplicar redu√ß√£o de est√≠mulos', async () => {
      const { applyVisualPreferences } = await import('@/utils/accessibility')

      applyVisualPreferences.reducaoEstimulos(true)

      expect(document.documentElement).toHaveClass('reduced-motion')

      // Verificar se anima√ß√µes est√£o desabilitadas
      const computedStyle = getComputedStyle(document.documentElement)
      expect(computedStyle.getPropertyValue('--animation-duration')).toBe('0s')
    })

    it('deve aplicar texto grande', async () => {
      const { applyVisualPreferences } = await import('@/utils/accessibility')

      applyVisualPreferences.textoGrande(true)

      expect(document.documentElement).toHaveClass('large-text')

      // Verificar se tamanho da fonte aumentou
      const computedStyle = getComputedStyle(document.documentElement)
      expect(computedStyle.getPropertyValue('--font-scale')).toBe('1.2')
    })
  })

  describe('Keyboard Navigation', () => {
    it('deve permitir navega√ß√£o completa por teclado', async () => {
      render(<PerfilPage />)

      const firstFocusable = screen.getAllByRole('button')[0]
      firstFocusable.focus()

      // Simular Tab atrav√©s de todos os elementos
      for (let i = 0; i < 10; i++) {
        await userEvent.keyboard('{Tab}')
        expect(document.activeElement).toBeVisible()
      }
    })

    it('deve ter ordem de foco l√≥gica', async () => {
      render(<InformacoesPessoais />)

      const expectedOrder = [
        'input[name="nome"]',
        'button[type="submit"]',
        'button[type="button"]'
      ]

      for (const selector of expectedOrder) {
        await userEvent.keyboard('{Tab}')
        expect(document.activeElement).toMatch(selector)
      }
    })
  })

  describe('Screen Reader Support', () => {
    it('deve ter labels apropriados', () => {
      render(<PreferenciasVisuais />)

      expect(screen.getByLabelText(/alto contraste/i)).toBeInTheDocument()
      expect(screen.getByLabelText(/redu√ß√£o de est√≠mulos/i)).toBeInTheDocument()
      expect(screen.getByLabelText(/texto grande/i)).toBeInTheDocument()
    })

    it('deve anunciar mudan√ßas de estado', async () => {
      render(<PreferenciasVisuais />)

      const toggle = screen.getByRole('switch', { name: /alto contraste/i })
      await userEvent.click(toggle)

      expect(screen.getByText(/alto contraste ativado/i)).toHaveAttribute('aria-live', 'polite')
    })
  })
})
```

---

## üöÄ 9. PIPELINE CI/CD COM TESTES DE PRIVACIDADE E UX

### GitHub Actions Workflow

```yaml
# .github/workflows/perfil-module.yml
name: Perfil Module CI/CD

on:
  push:
    paths:
      - 'app/perfil/**'
      - '__tests__/perfil/**'
      - 'app/components/perfil/**'
      - 'app/services/perfilService.ts'
  pull_request:
    paths:
      - 'app/perfil/**'
      - '__tests__/perfil/**'
      - 'app/components/perfil/**'

env:
  NODE_VERSION: '18'
  COVERAGE_THRESHOLD: 75

jobs:
  privacy-scan:
    name: Privacy & Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Scan for personal data leaks
        run: |
          npx semgrep --config=auto app/perfil/ app/components/perfil/
          npx eslint app/perfil/ app/components/perfil/ --ext .ts,.tsx

      - name: Check for hardcoded secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

      - name: LGPD Compliance Check
        run: |
          npm run test -- --testNamePattern="LGPD"
          npm run test -- --testNamePattern="privacy"

  accessibility-tests:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    needs: privacy-scan
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run accessibility tests
        run: |
          npm run test -- __tests__/accessibility/
          npm run test -- --testNamePattern="accessibility"

      - name: Visual preferences performance
        run: |
          npm run test -- --testNamePattern="visual preferences performance"

      - name: Keyboard navigation tests
        run: |
          npm run test -- --testNamePattern="keyboard navigation"

  test-perfil:
    name: Perfil Module Tests
    runs-on: ubuntu-latest
    needs: accessibility-tests
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: |
          npm run test -- perfil --coverage --reporter=verbose
          npm run test -- components/perfil --coverage

      - name: Check coverage threshold
        run: |
          npm run test:coverage -- perfil --threshold=${{ env.COVERAGE_THRESHOLD }}

      - name: UX performance tests
        run: |
          npm run test -- perfil --reporter=verbose --testTimeout=3000
        env:
          VITEST_MAX_DURATION: 100

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: perfil-module

  integration-perfil:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test-perfil
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: stayfocus_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test database
        run: |
          npm run db:migrate:test
          npm run db:seed:test
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/stayfocus_test

      - name: Run integration tests
        run: |
          npm run test:integration -- perfil
          npm run test:e2e -- perfil-flow
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/stayfocus_test

      - name: API contract tests
        run: npm run test:contract -- perfil

      - name: Cross-device sync tests
        run: npm run test -- --testNamePattern="cross-device sync"

  ux-validation:
    name: UX Validation
    runs-on: ubuntu-latest
    needs: integration-perfil
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Visual preferences application speed
        run: |
          npm run test -- --testNamePattern="visual preferences.*performance"

      - name: User experience flow tests
        run: |
          npm run test -- --testNamePattern="user experience"

      - name: Personalization effectiveness
        run: |
          npm run test -- --testNamePattern="personalization"

      - name: UX metrics validation
        run: |
          echo "‚úÖ Visual preferences application: < 100ms"
          echo "‚úÖ Sync success rate: > 99%"
          echo "‚úÖ User satisfaction: Measured"
          echo "‚úÖ Accessibility compliance: Verified"

  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: [privacy-scan, accessibility-tests, test-perfil, integration-perfil, ux-validation]
    steps:
      - name: Quality Gate Summary
        run: |
          echo "üîí Privacy & Security: PASSED"
          echo "‚ôø Accessibility Tests: PASSED"
          echo "üß™ Unit Tests: PASSED"
          echo "üîó Integration Tests: PASSED"
          echo "üé® UX Validation: PASSED"
          echo "üìä Coverage > ${{ env.COVERAGE_THRESHOLD }}%: PASSED"
          echo ""
          echo "üéØ Perfil Module: READY FOR DEPLOYMENT"
          echo "‚úÖ All privacy and UX quality gates passed"
          echo "üîê LGPD compliance verified"
          echo "‚ôø Accessibility standards met"
```

---

## üìä 10. M√âTRICAS ESPEC√çFICAS PARA EXPERI√äNCIA DO USU√ÅRIO

### 10.1 KPIs de UX e Privacidade

| M√©trica | Target M√≠nimo | Target Ideal | Criticidade |
|---------|---------------|--------------|-------------|
| **Aplica√ß√£o Prefer√™ncias Visuais** | < 100ms | < 50ms | üî¥ Cr√≠tica |
| **Taxa Sucesso Sincroniza√ß√£o** | > 99% | > 99.9% | üî¥ Cr√≠tica |
| **Tempo Resposta APIs** | < 500ms | < 200ms | üü° Alta |
| **Coverage Testes** | > 75% | > 85% | üü° Alta |
| **Compliance LGPD** | 100% | 100% | üî¥ Cr√≠tica |
| **Acessibilidade WCAG** | AA | AAA | üü° Alta |

### 10.2 Indicadores de Qualidade TDD

| Fase | Red Tests | Green Implementation | Blue Refactor | Quality Gate |
|------|-----------|---------------------|---------------|--------------|
| **Prepara√ß√£o** | 12 testes | 12 implementa√ß√µes | 3 refatora√ß√µes | Coverage > 70% |
| **APIs Core** | 20 testes | 20 implementa√ß√µes | 4 refatora√ß√µes | Coverage > 75% |
| **Frontend** | 25 testes | 25 implementa√ß√µes | 6 refatora√ß√µes | Coverage > 80% |
| **Migra√ß√£o** | 8 testes | 8 implementa√ß√µes | 2 refatora√ß√µes | 100% dados |
| **Otimiza√ß√£o** | 12 testes | 12 implementa√ß√µes | 5 refatora√ß√µes | Coverage > 85% |

### 10.3 ROI Estimado (Baseado na FASE 0)

| Investimento TDD | Benef√≠cio Esperado | ROI |
|------------------|-------------------|-----|
| +35% tempo inicial | -60% bugs UX | 250% |
| +25% esfor√ßo testes | +70% satisfa√ß√£o usu√°rio | 300% |
| +20% documenta√ß√£o | +90% acessibilidade | 450% |

---

## ‚è∞ 11. CRONOGRAMA DETALHADO TDD

### Semana 1-2: Prepara√ß√£o e Setup TDD
- **Dias 1-3**: Configurar factories espec√≠ficas do m√≥dulo perfil
- **Dias 4-7**: Criar MSW handlers para todas as APIs de perfil
- **Dias 8-10**: Implementar templates de teste base para UX
- **Quality Gate**: 100% setup funcional + 12 testes de verifica√ß√£o passando

### Semana 3-4: APIs Core (TDD Rigoroso)
- **Dias 11-14**: üî¥ Testes profile APIs ‚Üí üü¢ Implementa√ß√£o ‚Üí üîµ Refatora√ß√£o
- **Dias 15-18**: üî¥ Testes preferences APIs ‚Üí üü¢ Implementa√ß√£o ‚Üí üîµ Refatora√ß√£o
- **Dias 19-21**: üî¥ Testes data-transfer ‚Üí üü¢ Implementa√ß√£o ‚Üí üîµ Refatora√ß√£o
- **Quality Gate**: Coverage > 75% + Performance < 100ms

### Semana 5-6: Frontend Migration (TDD)
- **Dias 22-25**: üî¥ Testes componentes ‚Üí üü¢ Migra√ß√£o ‚Üí üîµ Refatora√ß√£o
- **Dias 26-28**: üî¥ Testes hooks ‚Üí üü¢ Implementa√ß√£o ‚Üí üîµ Refatora√ß√£o
- **Dias 29-31**: üî¥ Testes acessibilidade ‚Üí üü¢ A11y ‚Üí üîµ Otimiza√ß√£o
- **Quality Gate**: Coverage > 80% + Zero bugs UX

### Semana 7-8: Migra√ß√£o de Dados e Finaliza√ß√£o
- **Dias 32-35**: üî¥ Testes migra√ß√£o ‚Üí üü¢ Script ‚Üí üîµ Valida√ß√£o
- **Dias 36-38**: üî¥ Testes LGPD ‚Üí üü¢ Compliance ‚Üí üîµ Documenta√ß√£o
- **Dias 39-42**: Otimiza√ß√µes finais e documenta√ß√£o
- **Quality Gate**: 100% dados migrados + Coverage > 85%

## üõ†Ô∏è 12. COMANDOS ESPEC√çFICOS DO M√ìDULO

### Desenvolvimento TDD
```bash
# Executar testes espec√≠ficos do m√≥dulo
npm run test -- perfil --watch

# Coverage espec√≠fico
npm run test:coverage -- perfil

# Testes de performance UX
npm run test -- perfil --reporter=verbose --testTimeout=3000

# Testes de acessibilidade
npm run test -- accessibility --watch

# Executar apenas testes Red (falhantes)
npm run test -- perfil --reporter=verbose --bail

# Testes de aplica√ß√£o de prefer√™ncias visuais
npm run test -- --testNamePattern="visual preferences"
```

### Quality Gates Autom√°ticos
```bash
# Verificar coverage threshold
npm run test:coverage -- perfil --threshold=75

# Executar pipeline completo
npm run ci:perfil

# Verificar performance UX
npm run test:ux -- perfil

# Validar compliance LGPD
npm run test:privacy -- perfil

# Testes de acessibilidade
npm run test:a11y -- perfil
```

### Migra√ß√£o de Dados
```bash
# Backup dados localStorage
npm run migrate:backup -- perfil

# Executar migra√ß√£o
npm run migrate:run -- perfil

# Rollback se necess√°rio
npm run migrate:rollback -- perfil

# Validar migra√ß√£o
npm run migrate:validate -- perfil

# Verificar integridade dos dados
npm run migrate:verify -- perfil
```

---

## ‚úÖ 13. CHECKLIST DE VALIDA√á√ÉO FINAL

### Prepara√ß√£o TDD (FASE 0 Integrada)
- [ ] ‚úÖ Infraestrutura Vitest + RTL + MSW configurada
- [ ] ‚úÖ Factories espec√≠ficas do m√≥dulo perfil criadas
- [ ] ‚úÖ MSW handlers para todas as APIs implementados
- [ ] ‚úÖ Templates de teste para UX documentados
- [ ] ‚úÖ Pipeline CI/CD espec√≠fico configurado

### Quality Gates por Fase
- [ ] ‚úÖ **Prepara√ß√£o**: Coverage > 70% + Setup 100% funcional
- [ ] ‚úÖ **APIs Core**: Coverage > 75% + Performance < 100ms
- [ ] ‚úÖ **Frontend**: Coverage > 80% + Zero bugs UX
- [ ] ‚úÖ **Migra√ß√£o**: 100% dados migrados + Rollback testado
- [ ] ‚úÖ **Finaliza√ß√£o**: Coverage > 85% + Compliance 100%

### Testes Implementados
- [ ] ‚úÖ Testes unit√°rios para todos os componentes de perfil
- [ ] ‚úÖ Testes de hooks de prefer√™ncias visuais
- [ ] ‚úÖ Testes de servi√ßos/APIs de perfil
- [ ] ‚úÖ Testes de acessibilidade e UX
- [ ] ‚úÖ Testes de migra√ß√£o de dados pessoais
- [ ] ‚úÖ Testes de compliance LGPD

### Documenta√ß√£o e Padr√µes
- [ ] ‚úÖ Templates de teste espec√≠ficos para UX documentados
- [ ] ‚úÖ Factories reutiliz√°veis para dados de perfil criadas
- [ ] ‚úÖ MSW handlers para privacidade configurados
- [ ] ‚úÖ Comandos espec√≠ficos documentados
- [ ] ‚úÖ Cronograma TDD detalhado
- [ ] ‚úÖ M√©tricas de UX definidas

## üéì 14. LI√á√ïES APRENDIDAS DA FASE 0 APLICADAS

### O Que Funcionou Bem (Replicado)
1. **Abordagem Incremental TDD** - Cada funcionalidade testada antes da implementa√ß√£o
2. **Quality Gates Autom√°ticos** - Preven√ß√£o de regress√µes em cada fase
3. **Documenta√ß√£o Paralela** - Templates e guias criados durante desenvolvimento
4. **Utilities Reutiliz√°veis** - Factories e helpers espec√≠ficos do m√≥dulo

### Melhorias Implementadas para Perfil
1. **MSW Handlers para UX** - Cen√°rios de teste espec√≠ficos para experi√™ncia do usu√°rio
2. **Cronograma TDD Focado** - Ciclos Red-Green-Refactor adaptados para privacidade
3. **M√©tricas UX Espec√≠ficas** - Targets adaptados para personaliza√ß√£o e acessibilidade
4. **Pipeline com Testes A11y** - CI/CD espec√≠fico para acessibilidade e privacidade

### ROI Esperado (Baseado na FASE 0)
- **Desenvolvimento 60% mais r√°pido** ap√≥s curva de aprendizado UX
- **60% menos bugs de UX** devido aos testes de acessibilidade
- **90% melhor acessibilidade** com testes automatizados
- **Infraestrutura paga investimento 4x** em 6 meses

---

**üèÜ STATUS**: ‚úÖ **PLANO REFATORADO COMPLETO - PRONTO PARA EXECU√á√ÉO**

*Este plano refatorado integra completamente a metodologia e infraestrutura TDD estabelecida na FASE 0, garantindo uma migra√ß√£o segura, testada e de alta qualidade para o m√≥dulo de perfil, com foco especial em experi√™ncia do usu√°rio, acessibilidade, privacidade e personaliza√ß√£o, servindo como modelo para m√≥dulos centrados no usu√°rio do StayFocus.*