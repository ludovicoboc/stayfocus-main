# üìã PLANO DE MIGRA√á√ÉO TDD - M√ìDULO ALIMENTA√á√ÉO

## üéØ CONTEXTO

Migra√ß√£o do m√≥dulo de alimenta√ß√£o de uma arquitetura baseada em localStorage para uma arquitetura de dados dual, seguindo **metodologia TDD rigorosa** estabelecida na FASE 0:
- **Produ√ß√£o**: Supabase (PostgreSQL com RLS)
- **Desenvolvimento/Testes**: Backend FastAPI local (SQLAlchemy + PostgreSQL local)
- **Metodologia**: Test-Driven Development (Red-Green-Refactor)
- **Infraestrutura**: Vitest + RTL + MSW + Quality Gates autom√°ticos

## üß™ PREPARA√á√ÉO TDD - INFRAESTRUTURA PRONTA

### ‚úÖ Ferramentas Configuradas (FASE 0)
- **Vitest** - Test runner com coverage V8 (target: 70%+)
- **React Testing Library** - Testes user-centric
- **MSW** - Mock Service Worker para APIs
- **GitHub Actions** - Pipeline CI/CD com 7 quality gates
- **Factories & Utilities** - Gera√ß√£o de dados e helpers

### üéØ Quality Gates Autom√°ticos
| M√©trica | M√≠nimo | Ideal |
|---------|--------|-------|
| Coverage Lines | 70% | 85% |
| Coverage Functions | 70% | 85% |
| Test Performance | < 100ms | < 50ms |
| Suite Completa | < 30s | < 15s |

---

## üîç 1. RELAT√ìRIO DE AUDITORIA DO LOCALSTORAGE + TESTES

### Invent√°rio de Chaves e Dados Armazenados

**Chave: `alimentacao-storage`**
- **Dados**: Planejador de refei√ß√µes, registro de refei√ß√µes e controle de hidrata√ß√£o
- **Estrutura**:
  ```json
  {
    "refeicoes": [
      {
        "id": "string",
        "horario": "string (HH:MM)",
        "descricao": "string"
      }
    ],
    "registros": [
      {
        "id": "string",
        "data": "string (YYYY-MM-DD)",
        "horario": "string (HH:MM)",
        "descricao": "string",
        "tipoIcone": "string | null",
        "foto": "string | null (base64 ou URL)"
      }
    ],
    "coposBebidos": "number",
    "metaDiaria": "number",
    "ultimoRegistro": "string | null (HH:MM)"
  }
  ```

### üß™ Factories TDD para Dados Existentes

```typescript
// __tests__/factories/alimentacao.ts
export const createMealPlan = (overrides = {}) => ({
  id: `meal-${counter++}`,
  horario: '12:00',
  descricao: 'Almo√ßo padr√£o',
  ...overrides
})

export const createMealRecord = (overrides = {}) => ({
  id: `record-${counter++}`,
  data: '2025-01-20',
  horario: '12:30',
  descricao: 'Almo√ßo registrado',
  tipoIcone: 'cafe',
  foto: null,
  ...overrides
})

export const createHydrationData = (overrides = {}) => ({
  coposBebidos: 3,
  metaDiaria: 8,
  ultimoRegistro: '14:30',
  ...overrides
})
```

**Chave: `receitas-storage`** (Relacionada)
- **Dados**: Receitas culin√°rias e favoritos
- **Estrutura**:
  ```json
  {
    "receitas": [
      {
        "id": "string",
        "nome": "string",
        "descricao": "string",
        "categorias": "string[]",
        "tags": "string[]",
        "tempoPreparo": "number",
        "porcoes": "number",
        "calorias": "string",
        "imagem": "string",
        "ingredientes": [
          {
            "nome": "string",
            "quantidade": "number",
            "unidade": "string"
          }
        ],
        "passos": "string[]"
      }
    ],
    "favoritos": "string[]"
  }
  ```

### Componentes Dependentes + Estrat√©gia de Testes

| Componente | Responsabilidade | Estrat√©gia TDD |
|------------|------------------|----------------|
| **PlanejadorRefeicoes.tsx** | Gerencia hor√°rios e descri√ß√µes | ‚úÖ Testes de CRUD + Valida√ß√£o |
| **RegistroRefeicoes.tsx** | Registra refei√ß√µes com fotos | ‚úÖ Testes de Upload + Formul√°rio |
| **LembreteHidratacao.tsx** | Controla intake de √°gua | ‚úÖ Testes de Contador + Estado |
| **M√≥dulo de Receitas** | Sistema completo de receitas | ‚úÖ Testes de Busca + Favoritos |

### üéØ Cobertura de Testes Planejada

```typescript
// Estrutura de testes para o m√≥dulo
__tests__/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ PlanejadorRefeicoes.test.tsx     # CRUD + Valida√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ RegistroRefeicoes.test.tsx       # Upload + Formul√°rio
‚îÇ   ‚îú‚îÄ‚îÄ LembreteHidratacao.test.tsx      # Contador + Estado
‚îÇ   ‚îî‚îÄ‚îÄ ReceitasModule.test.tsx          # Busca + Favoritos
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useAlimentacao.test.ts           # Store + Mutations
‚îÇ   ‚îú‚îÄ‚îÄ useHidratacao.test.ts            # Hydration logic
‚îÇ   ‚îî‚îÄ‚îÄ useReceitas.test.ts              # Recipes queries
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ alimentacaoApi.test.ts           # API calls
‚îÇ   ‚îî‚îÄ‚îÄ uploadService.test.ts            # File upload
‚îî‚îÄ‚îÄ integration/
    ‚îî‚îÄ‚îÄ alimentacao-flow.test.tsx        # E2E scenarios
```

---

## üóÑÔ∏è 2. ESQUEMA DE BANCO DE DADOS UNIFICADO (SQL)

```sql
-- Tabela de usu√°rios (base para todo o sistema)
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de refei√ß√µes planejadas
CREATE TABLE meal_plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    time VARCHAR(5) NOT NULL, -- HH:MM format
    description VARCHAR(500) NOT NULL,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de registros de refei√ß√µes
CREATE TABLE meal_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    time VARCHAR(5) NOT NULL, -- HH:MM format
    description VARCHAR(500) NOT NULL,
    meal_type VARCHAR(50), -- 'cafe', 'fruta', 'salada', etc.
    photo_url VARCHAR(1000),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de controle de hidrata√ß√£o
CREATE TABLE hydration_tracking (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    glasses_consumed INTEGER DEFAULT 0,
    daily_goal INTEGER DEFAULT 8,
    last_record_time VARCHAR(5), -- HH:MM format
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, date)
);

-- Tabela de categorias de receitas
CREATE TABLE recipe_categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de receitas
CREATE TABLE recipes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    prep_time_minutes INTEGER,
    servings INTEGER,
    calories VARCHAR(50),
    image_url VARCHAR(1000),
    instructions TEXT[], -- Array de strings para os passos
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de ingredientes de receitas
CREATE TABLE recipe_ingredients (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    recipe_id UUID NOT NULL REFERENCES recipes(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    quantity DECIMAL(10,2) NOT NULL,
    unit VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de tags de receitas
CREATE TABLE recipe_tags (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    recipe_id UUID NOT NULL REFERENCES recipes(id) ON DELETE CASCADE,
    tag VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de categoriza√ß√£o de receitas
CREATE TABLE recipe_category_assignments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    recipe_id UUID NOT NULL REFERENCES recipes(id) ON DELETE CASCADE,
    category_id UUID NOT NULL REFERENCES recipe_categories(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(recipe_id, category_id)
);

-- Tabela de receitas favoritas
CREATE TABLE favorite_recipes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    recipe_id UUID NOT NULL REFERENCES recipes(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, recipe_id)
);

-- √çndices para performance
CREATE INDEX idx_meal_plans_user_id ON meal_plans(user_id);
CREATE INDEX idx_meal_records_user_date ON meal_records(user_id, date);
CREATE INDEX idx_hydration_user_date ON hydration_tracking(user_id, date);
CREATE INDEX idx_recipes_user_id ON recipes(user_id);
CREATE INDEX idx_recipe_ingredients_recipe_id ON recipe_ingredients(recipe_id);
CREATE INDEX idx_recipe_tags_recipe_id ON recipe_tags(recipe_id);
CREATE INDEX idx_favorite_recipes_user_id ON favorite_recipes(user_id);
```

---

## üåê 3. CONTRATO DE API (OpenAPI/Swagger Simplificado)

### Autentica√ß√£o
```markdown
POST /auth/login
- Payload Request: { "email": "string", "password": "string" }
- Payload Response: { "token": "string", "user": { "id": "uuid", "name": "string", "email": "string" } }
- Status Codes: 200 (Success), 401 (Unauthorized), 400 (Bad Request)

GET /auth/me
- Headers: Authorization: Bearer {token}
- Payload Response: { "id": "uuid", "name": "string", "email": "string" }
- Status Codes: 200 (Success), 401 (Unauthorized)
```

### Planejador de Refei√ß√µes
```markdown
GET /api/meal-plans
- Headers: Authorization: Bearer {token}
- Payload Response: [{ "id": "uuid", "time": "07:30", "description": "Caf√© da manh√£", "isActive": true }]
- Status Codes: 200 (Success), 401 (Unauthorized)

POST /api/meal-plans
- Headers: Authorization: Bearer {token}
- Payload Request: { "time": "19:30", "description": "Jantar" }
- Payload Response: { "id": "uuid", "time": "19:30", "description": "Jantar", "isActive": true }
- Status Codes: 201 (Created), 400 (Bad Request), 401 (Unauthorized)

PUT /api/meal-plans/{id}
- Headers: Authorization: Bearer {token}
- Payload Request: { "time": "20:00", "description": "Jantar tardio" }
- Payload Response: { "id": "uuid", "time": "20:00", "description": "Jantar tardio", "isActive": true }
- Status Codes: 200 (Success), 404 (Not Found), 401 (Unauthorized)

DELETE /api/meal-plans/{id}
- Headers: Authorization: Bearer {token}
- Status Codes: 204 (No Content), 404 (Not Found), 401 (Unauthorized)
```

### Registro de Refei√ß√µes
```markdown
GET /api/meal-records
- Headers: Authorization: Bearer {token}
- Query Params: ?date=YYYY-MM-DD (opcional)
- Payload Response: [{ "id": "uuid", "date": "2025-03-03", "time": "08:30", "description": "Caf√© da manh√£", "mealType": "cafe", "photoUrl": "https://..." }]
- Status Codes: 200 (Success), 401 (Unauthorized)

POST /api/meal-records
- Headers: Authorization: Bearer {token}
- Payload Request: { "time": "08:30", "description": "Caf√© da manh√£", "mealType": "cafe", "photoUrl": "data:image/..." }
- Payload Response: { "id": "uuid", "date": "2025-03-03", "time": "08:30", "description": "Caf√© da manh√£", "mealType": "cafe", "photoUrl": "https://..." }
- Status Codes: 201 (Created), 400 (Bad Request), 401 (Unauthorized)

DELETE /api/meal-records/{id}
- Headers: Authorization: Bearer {token}
- Status Codes: 204 (No Content), 404 (Not Found), 401 (Unauthorized)
```

### Controle de Hidrata√ß√£o
```markdown
GET /api/hydration/today
- Headers: Authorization: Bearer {token}
- Payload Response: { "date": "2025-03-03", "glassesConsumed": 3, "dailyGoal": 8, "lastRecordTime": "14:30" }
- Status Codes: 200 (Success), 401 (Unauthorized)

POST /api/hydration/add-glass
- Headers: Authorization: Bearer {token}
- Payload Response: { "date": "2025-03-03", "glassesConsumed": 4, "dailyGoal": 8, "lastRecordTime": "15:45" }
- Status Codes: 200 (Success), 400 (Goal Reached), 401 (Unauthorized)

POST /api/hydration/remove-glass
- Headers: Authorization: Bearer {token}
- Payload Response: { "date": "2025-03-03", "glassesConsumed": 2, "dailyGoal": 8, "lastRecordTime": "14:30" }
- Status Codes: 200 (Success), 400 (No Glasses), 401 (Unauthorized)

PUT /api/hydration/goal
- Headers: Authorization: Bearer {token}
- Payload Request: { "dailyGoal": 10 }
- Payload Response: { "date": "2025-03-03", "glassesConsumed": 3, "dailyGoal": 10, "lastRecordTime": "14:30" }
- Status Codes: 200 (Success), 400 (Invalid Goal), 401 (Unauthorized)
```

### Receitas
```markdown
GET /api/recipes
- Headers: Authorization: Bearer {token}
- Query Params: ?category=string&tag=string&favorite=boolean
- Payload Response: [{ "id": "uuid", "name": "Receita Exemplo", "description": "...", "prepTime": 30, "servings": 4, "calories": "250", "imageUrl": "https://...", "isFavorite": true }]
- Status Codes: 200 (Success), 401 (Unauthorized)

POST /api/recipes
- Headers: Authorization: Bearer {token}
- Payload Request: { "name": "Nova Receita", "description": "...", "prepTime": 45, "servings": 2, "calories": "300", "imageUrl": "...", "ingredients": [...], "instructions": [...], "categories": [...], "tags": [...] }
- Payload Response: { "id": "uuid", "name": "Nova Receita", ... }
- Status Codes: 201 (Created), 400 (Bad Request), 401 (Unauthorized)

GET /api/recipes/{id}
- Headers: Authorization: Bearer {token}
- Payload Response: { "id": "uuid", "name": "Receita Completa", "ingredients": [...], "instructions": [...], "categories": [...], "tags": [...] }
- Status Codes: 200 (Success), 404 (Not Found), 401 (Unauthorized)

POST /api/recipes/{id}/favorite
- Headers: Authorization: Bearer {token}
- Status Codes: 200 (Success), 404 (Not Found), 401 (Unauthorized)

DELETE /api/recipes/{id}/favorite
- Headers: Authorization: Bearer {token}
- Status Codes: 204 (No Content), 404 (Not Found), 401 (Unauthorized)
```

---

## üìã 4. PLANO DE MIGRA√á√ÉO TDD DUAL-TRACK (M√âTODO MOSCOW)

### **MUST HAVE (Cr√≠tico + TDD Rigoroso)**

#### üî¥ RED ‚Üí üü¢ GREEN ‚Üí üîµ REFACTOR

1. **[TDD Backend]** Testes de autentica√ß√£o JWT ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
2. **[TDD Backend]** Testes APIs meal-plans/records/hydration ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
3. **[TDD Frontend]** Testes service layer ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
4. **[TDD Frontend]** Testes fallback localStorage ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
5. **[TDD Database]** Testes schema + migrations ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o

**Quality Gate**: ‚úÖ Coverage > 70% + Todos os testes passando antes de prosseguir

### **SHOULD HAVE (TDD + Experi√™ncia Completa)**

6. **[TDD Backend]** Testes APIs receitas + upload ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
7. **[TDD Frontend]** Testes migra√ß√£o stores ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
8. **[TDD Frontend]** Testes sync offline/online ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
9. **[TDD Database]** Testes RLS Supabase ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
10. **[TDD Migration]** Testes script migra√ß√£o ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o

**Quality Gate**: ‚úÖ Coverage > 75% + Performance < 100ms + Zero bugs cr√≠ticos

### **COULD HAVE (TDD + Otimiza√ß√£o)**

11. **[TDD Backend]** Testes cache Redis ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
12. **[TDD Frontend]** Testes optimistic updates ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
13. **[TDD Frontend]** Testes backup/restore ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
14. **[TDD Monitoring]** Testes logs/m√©tricas ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o
15. **[TDD Performance]** Testes pagina√ß√£o/lazy ‚Üí Implementa√ß√£o ‚Üí Refatora√ß√£o

**Quality Gate**: ‚úÖ Coverage > 80% + Performance < 50ms + M√©tricas de qualidade

### **WON'T HAVE (N√£o implementar nesta itera√ß√£o)**

16. **[Features]** Sistema de compartilhamento de receitas entre usu√°rios
17. **[Features]** An√°lise nutricional autom√°tica com IA
18. **[Infrastructure]** Deploy automatizado com CI/CD (j√° configurado na FASE 0)
19. **[Features]** Notifica√ß√µes push para lembretes
20. **[Features]** Integra√ß√£o com wearables para hidrata√ß√£o

---

## üîß CHECKLIST DE IMPLEMENTA√á√ÉO TDD

### **Fase 1: Prepara√ß√£o TDD (Must Have)**
- [ ] üî¥ Escrever testes de autentica√ß√£o JWT ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Escrever testes RLS Supabase ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Escrever testes schema BD ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Escrever testes service layer ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Escrever testes env config ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] ‚úÖ **Quality Gate**: Coverage > 70% + Todos os testes passando

### **Fase 2: APIs Core TDD (Must Have + Should Have)**
- [ ] üî¥ Testes CRUD meal-plans ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes CRUD meal-records ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes hydration tracking ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes upload imagens ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes CRUD receitas ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] ‚úÖ **Quality Gate**: Coverage > 75% + Performance < 100ms

### **Fase 3: Migra√ß√£o Frontend TDD (Should Have)**
- [ ] üî¥ Testes PlanejadorRefeicoes ‚Üí üü¢ Migrar APIs ‚Üí üîµ Refatorar
- [ ] üî¥ Testes RegistroRefeicoes ‚Üí üü¢ Migrar APIs ‚Üí üîµ Refatorar
- [ ] üî¥ Testes LembreteHidratacao ‚Üí üü¢ Migrar APIs ‚Üí üîµ Refatorar
- [ ] üî¥ Testes sistema receitas ‚Üí üü¢ Migrar APIs ‚Üí üîµ Refatorar
- [ ] üî¥ Testes sincroniza√ß√£o ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] ‚úÖ **Quality Gate**: Coverage > 80% + Zero bugs cr√≠ticos

### **Fase 4: Script Migra√ß√£o TDD (Should Have)**
- [ ] üî¥ Testes export localStorage ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes import BD ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes migra√ß√£o real ‚Üí üü¢ Executar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes rollback ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] ‚úÖ **Quality Gate**: 100% dados migrados + Zero perda

### **Fase 5: Otimiza√ß√µes TDD (Could Have)**
- [ ] üî¥ Testes cache frontend ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes otimiza√ß√£o queries ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes compress√£o imagens ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] üî¥ Testes logs/m√©tricas ‚Üí üü¢ Implementar ‚Üí üîµ Refatorar
- [ ] ‚úÖ **Quality Gate**: Coverage > 85% + Performance < 50ms

---

## üß™ TEMPLATES DE TESTE ESPEC√çFICOS DO M√ìDULO

### Template: Componente PlanejadorRefeicoes

```typescript
// __tests__/components/PlanejadorRefeicoes.test.tsx
import { render, screen, userEvent } from '@/test-utils'
import { PlanejadorRefeicoes } from '@/components/alimentacao/PlanejadorRefeicoes'
import { createMealPlan, createList } from '@/factories/alimentacao'

describe('PlanejadorRefeicoes', () => {
  const defaultProps = {
    mealPlans: createList(createMealPlan, 3),
    onAdd: vi.fn(),
    onEdit: vi.fn(),
    onDelete: vi.fn(),
  }

  beforeEach(() => {
    vi.clearAllMocks()
  })

  describe('üî¥ RED: Renderiza√ß√£o', () => {
    it('deve renderizar lista de refei√ß√µes planejadas', () => {
      render(<PlanejadorRefeicoes {...defaultProps} />)

      defaultProps.mealPlans.forEach(meal => {
        expect(screen.getByText(meal.descricao)).toBeInTheDocument()
        expect(screen.getByText(meal.horario)).toBeInTheDocument()
      })
    })

    it('deve mostrar formul√°rio de adi√ß√£o', () => {
      render(<PlanejadorRefeicoes {...defaultProps} />)
      expect(screen.getByRole('button', { name: /adicionar refei√ß√£o/i })).toBeInTheDocument()
    })
  })

  describe('üü¢ GREEN: Intera√ß√µes', () => {
    it('deve adicionar nova refei√ß√£o quando formul√°rio √© submetido', async () => {
      const user = userEvent.setup()
      render(<PlanejadorRefeicoes {...defaultProps} />)

      await user.click(screen.getByRole('button', { name: /adicionar/i }))
      await user.type(screen.getByLabelText(/hor√°rio/i), '14:30')
      await user.type(screen.getByLabelText(/descri√ß√£o/i), 'Lanche da tarde')
      await user.click(screen.getByRole('button', { name: /salvar/i }))

      expect(defaultProps.onAdd).toHaveBeenCalledWith({
        horario: '14:30',
        descricao: 'Lanche da tarde'
      })
    })
  })

  describe('ÔøΩ REFACTOR: Estados e Valida√ß√£o', () => {
    it('deve validar campos obrigat√≥rios', async () => {
      const user = userEvent.setup()
      render(<PlanejadorRefeicoes {...defaultProps} />)

      await user.click(screen.getByRole('button', { name: /adicionar/i }))
      await user.click(screen.getByRole('button', { name: /salvar/i }))

      expect(screen.getByText(/hor√°rio √© obrigat√≥rio/i)).toBeInTheDocument()
      expect(screen.getByText(/descri√ß√£o √© obrigat√≥ria/i)).toBeInTheDocument()
    })
  })
})
```

### Template: Hook useAlimentacao

```typescript
// __tests__/hooks/useAlimentacao.test.ts
import { renderHook, act } from '@testing-library/react'
import { useAlimentacao } from '@/hooks/useAlimentacao'
import { createQueryWrapper } from '@/test-utils'
import { server } from '@/mocks/server'
import { http, HttpResponse } from 'msw'

describe('useAlimentacao', () => {
  describe('üî¥ RED: Estado Inicial', () => {
    it('deve retornar estado inicial correto', () => {
      const { result } = renderHook(() => useAlimentacao(), {
        wrapper: createQueryWrapper()
      })

      expect(result.current.mealPlans).toEqual([])
      expect(result.current.isLoading).toBe(true)
      expect(result.current.error).toBe(null)
    })
  })

  describe('üü¢ GREEN: Opera√ß√µes CRUD', () => {
    it('deve adicionar refei√ß√£o com sucesso', async () => {
      const newMeal = createMealPlan({ horario: '15:00', descricao: 'Lanche' })

      server.use(
        http.post('/api/meal-plans', () => {
          return HttpResponse.json(newMeal)
        })
      )

      const { result } = renderHook(() => useAlimentacao(), {
        wrapper: createQueryWrapper()
      })

      await act(async () => {
        await result.current.addMealPlan(newMeal)
      })

      expect(result.current.mealPlans).toContainEqual(newMeal)
    })
  })

  describe('üîµ REFACTOR: Error Handling', () => {
    it('deve lidar com erros de API', async () => {
      server.use(
        http.post('/api/meal-plans', () => {
          return HttpResponse.error()
        })
      )

      const { result } = renderHook(() => useAlimentacao(), {
        wrapper: createQueryWrapper()
      })

      await act(async () => {
        try {
          await result.current.addMealPlan(createMealPlan())
        } catch (error) {
          expect(error).toBeDefined()
        }
      })

      expect(result.current.error).toBeDefined()
    })
  })
})
```

### Template: Servi√ßo AlimentacaoAPI

```typescript
// __tests__/services/alimentacaoApi.test.ts
import { vi } from 'vitest'
import { alimentacaoApi } from '@/services/alimentacaoApi'
import { server } from '@/mocks/server'
import { http, HttpResponse } from 'msw'
import { createMealPlan, createMealRecord } from '@/factories/alimentacao'

describe('AlimentacaoAPI', () => {
  describe('üî¥ RED: Meal Plans API', () => {
    it('deve buscar meal plans do usu√°rio', async () => {
      const mockPlans = [createMealPlan(), createMealPlan()]

      server.use(
        http.get('/api/meal-plans', () => HttpResponse.json(mockPlans))
      )

      const result = await alimentacaoApi.getMealPlans()
      expect(result).toEqual(mockPlans)
    })
  })

  describe('üü¢ GREEN: Error Handling', () => {
    it('deve lidar com erro 500 da API', async () => {
      server.use(
        http.get('/api/meal-plans', () => HttpResponse.error())
      )

      await expect(alimentacaoApi.getMealPlans()).rejects.toThrow()
    })
  })

  describe('üîµ REFACTOR: Optimistic Updates', () => {
    it('deve implementar optimistic updates para meal records', async () => {
      const newRecord = createMealRecord()

      server.use(
        http.post('/api/meal-records', () => HttpResponse.json(newRecord))
      )

      const result = await alimentacaoApi.addMealRecord(newRecord)
      expect(result.id).toBeDefined()
      expect(result.descricao).toBe(newRecord.descricao)
    })
  })
})
```

### Template: Integra√ß√£o E2E

```typescript
// __tests__/integration/alimentacao-flow.test.tsx
import { render, screen, userEvent } from '@/test-utils'
import { AlimentacaoPage } from '@/app/alimentacao/page'
import { server } from '@/mocks/server'
import { http, HttpResponse } from 'msw'

describe('Alimenta√ß√£o E2E Flow', () => {
  describe('üî¥ RED: Fluxo Completo', () => {
    it('deve permitir planejamento ‚Üí registro ‚Üí hidrata√ß√£o', async () => {
      const user = userEvent.setup()

      // Setup API mocks
      server.use(
        http.get('/api/meal-plans', () => HttpResponse.json([])),
        http.post('/api/meal-plans', () => HttpResponse.json({ id: '1' })),
        http.post('/api/meal-records', () => HttpResponse.json({ id: '1' })),
        http.post('/api/hydration/add-glass', () => HttpResponse.json({ glassesConsumed: 1 }))
      )

      render(<AlimentacaoPage />)

      // 1. Planejar refei√ß√£o
      await user.click(screen.getByRole('button', { name: /planejar refei√ß√£o/i }))
      await user.type(screen.getByLabelText(/hor√°rio/i), '12:00')
      await user.type(screen.getByLabelText(/descri√ß√£o/i), 'Almo√ßo')
      await user.click(screen.getByRole('button', { name: /salvar/i }))

      // 2. Registrar refei√ß√£o
      await user.click(screen.getByRole('button', { name: /registrar refei√ß√£o/i }))
      await user.type(screen.getByLabelText(/descri√ß√£o/i), 'Almo√ßo consumido')
      await user.click(screen.getByRole('button', { name: /registrar/i }))

      // 3. Adicionar copo de √°gua
      await user.click(screen.getByRole('button', { name: /adicionar copo/i }))

      // Verificar estado final
      expect(screen.getByText(/1 de 8 copos/i)).toBeInTheDocument()
    })
  })
})
```

---

## ÔøΩüöÄ CONSIDERA√á√ïES T√âCNICAS TDD

### Arquitetura do Service Layer
```typescript
// Exemplo de service abstrato para dual-track
interface IAlimentacaoService {
  getMealPlans(): Promise<MealPlan[]>
  addMealPlan(plan: CreateMealPlanDto): Promise<MealPlan>
  updateMealPlan(id: string, plan: UpdateMealPlanDto): Promise<MealPlan>
  deleteMealPlan(id: string): Promise<void>
}

// Implementa√ß√£o para FastAPI
class FastAPIAlimentacaoService implements IAlimentacaoService {
  // implementa√ß√£o espec√≠fica
}

// Implementa√ß√£o para Supabase
class SupabaseAlimentacaoService implements IAlimentacaoService {
  // implementa√ß√£o espec√≠fica
}
```

### MSW Handlers Espec√≠ficos do M√≥dulo

```typescript
// __tests__/mocks/handlers/alimentacao.ts
import { http, HttpResponse } from 'msw'
import { createMealPlan, createMealRecord, createHydrationData } from '@/factories/alimentacao'

export const alimentacaoHandlers = [
  // Meal Plans
  http.get('/api/meal-plans', () => {
    return HttpResponse.json([
      createMealPlan({ horario: '07:00', descricao: 'Caf√© da manh√£' }),
      createMealPlan({ horario: '12:00', descricao: 'Almo√ßo' }),
      createMealPlan({ horario: '19:00', descricao: 'Jantar' })
    ])
  }),

  http.post('/api/meal-plans', async ({ request }) => {
    const newPlan = await request.json()
    return HttpResponse.json(createMealPlan(newPlan), { status: 201 })
  }),

  http.put('/api/meal-plans/:id', async ({ request, params }) => {
    const updates = await request.json()
    return HttpResponse.json(createMealPlan({ id: params.id, ...updates }))
  }),

  http.delete('/api/meal-plans/:id', () => {
    return new HttpResponse(null, { status: 204 })
  }),

  // Meal Records
  http.get('/api/meal-records', ({ request }) => {
    const url = new URL(request.url)
    const date = url.searchParams.get('date')

    return HttpResponse.json([
      createMealRecord({ data: date || '2025-01-20' })
    ])
  }),

  http.post('/api/meal-records', async ({ request }) => {
    const newRecord = await request.json()
    return HttpResponse.json(createMealRecord(newRecord), { status: 201 })
  }),

  // Hydration
  http.get('/api/hydration/today', () => {
    return HttpResponse.json(createHydrationData())
  }),

  http.post('/api/hydration/add-glass', () => {
    return HttpResponse.json(createHydrationData({ coposBebidos: 4 }))
  }),

  http.post('/api/hydration/remove-glass', () => {
    return HttpResponse.json(createHydrationData({ coposBebidos: 2 }))
  }),

  // Error scenarios
  http.get('/api/meal-plans/error', () => {
    return HttpResponse.error()
  }),

  http.post('/api/meal-plans/timeout', () => {
    return new Promise(() => {}) // Never resolves (timeout)
  })
]
```

### Estrat√©gia de Migra√ß√£o TDD
1. **üî¥ Testes de backup** ‚Üí **üü¢ Backup autom√°tico** ‚Üí **üîµ Refatora√ß√£o**
2. **üî¥ Testes migra√ß√£o gradual** ‚Üí **üü¢ Implementa√ß√£o por etapas** ‚Üí **üîµ Otimiza√ß√£o**
3. **üî¥ Testes modo h√≠brido** ‚Üí **üü¢ Transi√ß√£o controlada** ‚Üí **üîµ Limpeza**
4. **üî¥ Testes rollback** ‚Üí **üü¢ Recupera√ß√£o autom√°tica** ‚Üí **üîµ Valida√ß√£o**

---

## üîß PIPELINE CI/CD ESPEC√çFICO DO M√ìDULO

### GitHub Actions Workflow

```yaml
# .github/workflows/alimentacao-module.yml
name: Alimenta√ß√£o Module CI/CD

on:
  push:
    paths:
      - 'app/alimentacao/**'
      - '__tests__/alimentacao/**'
      - 'app/components/alimentacao/**'

jobs:
  test-alimentacao:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Alimenta√ß√£o Tests
        run: npm run test -- alimentacao --coverage

      - name: Check Coverage Threshold
        run: |
          COVERAGE=$(npm run test:coverage -- --reporter=json | jq '.total.lines.pct')
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "Coverage $COVERAGE% below threshold 70%"
            exit 1
          fi

      - name: Performance Tests
        run: npm run test -- alimentacao --reporter=verbose
        env:
          VITEST_MAX_DURATION: 100

  integration-alimentacao:
    needs: test-alimentacao
    runs-on: ubuntu-latest
    steps:
      - name: Integration Tests
        run: npm run test:integration -- alimentacao

      - name: API Contract Tests
        run: npm run test:contract -- alimentacao

  quality-gates:
    needs: [test-alimentacao, integration-alimentacao]
    runs-on: ubuntu-latest
    steps:
      - name: Quality Gate Check
        run: |
          echo "‚úÖ Unit Tests: Passed"
          echo "‚úÖ Integration Tests: Passed"
          echo "‚úÖ Coverage > 70%: Passed"
          echo "‚úÖ Performance < 100ms: Passed"
          echo "üéØ Alimenta√ß√£o Module: READY FOR DEPLOYMENT"
```

---

## üìä M√âTRICAS DE SUCESSO TDD

### Indicadores T√©cnicos (Baseados na FASE 0)

| M√©trica | Target FASE 0 | Target Alimenta√ß√£o | Status |
|---------|---------------|-------------------|--------|
| **Coverage Lines** | 70% | 75% | üéØ |
| **Coverage Functions** | 70% | 75% | üéØ |
| **Test Performance** | < 100ms | < 80ms | üéØ |
| **Suite Completa** | < 30s | < 10s | üéØ |
| **Zero Bugs Cr√≠ticos** | ‚úÖ | ‚úÖ | üéØ |

### Indicadores de Qualidade TDD

| Fase | Red Tests | Green Implementation | Blue Refactor | Quality Gate |
|------|-----------|---------------------|---------------|--------------|
| **Prepara√ß√£o** | 15 testes | 15 implementa√ß√µes | 3 refatora√ß√µes | Coverage > 70% |
| **APIs Core** | 25 testes | 25 implementa√ß√µes | 5 refatora√ß√µes | Coverage > 75% |
| **Frontend** | 35 testes | 35 implementa√ß√µes | 7 refatora√ß√µes | Coverage > 80% |
| **Migra√ß√£o** | 10 testes | 10 implementa√ß√µes | 2 refatora√ß√µes | 100% dados |
| **Otimiza√ß√£o** | 15 testes | 15 implementa√ß√µes | 8 refatora√ß√µes | Coverage > 85% |

### ROI Estimado (Baseado na FASE 0)

| Investimento TDD | Benef√≠cio Esperado | ROI |
|------------------|-------------------|-----|
| +40% tempo inicial | -70% bugs produ√ß√£o | 300% |
| +20% esfor√ßo testes | +50% velocidade manuten√ß√£o | 250% |
| +30% documenta√ß√£o | +80% onboarding novos devs | 400% |

---

## üéØ PR√ìXIMOS PASSOS P√ìS-ALIMENTA√á√ÉO

### Replica√ß√£o para Outros M√≥dulos

1. **Usar este plano como template** para Sa√∫de, Sono, Estudos, etc.
2. **Adaptar factories e mocks** espec√≠ficos de cada m√≥dulo
3. **Manter quality gates** consistentes em todos os m√≥dulos
4. **Documentar li√ß√µes aprendidas** para otimizar pr√≥ximas migra√ß√µes

### Evolu√ß√£o Cont√≠nua

1. **Revisar m√©tricas trimestralmente** baseado nos resultados
2. **Atualizar ferramentas** seguindo evolu√ß√£o do ecossistema
3. **Expandir utilities** conforme padr√µes emergentes
4. **Treinar equipe** nas pr√°ticas TDD estabelecidas

---

## ‚è∞ CRONOGRAMA DETALHADO TDD

### Semana 1-2: Prepara√ß√£o e Setup TDD
- **Dias 1-3**: Configurar factories espec√≠ficas do m√≥dulo
- **Dias 4-7**: Criar MSW handlers para todas as APIs
- **Dias 8-10**: Implementar templates de teste base
- **Quality Gate**: 100% setup funcional + 6 testes de verifica√ß√£o passando

### Semana 3-4: APIs Core (TDD Rigoroso)
- **Dias 11-14**: üî¥ Testes meal-plans ‚Üí üü¢ Implementa√ß√£o ‚Üí üîµ Refatora√ß√£o
- **Dias 15-18**: üî¥ Testes meal-records ‚Üí üü¢ Implementa√ß√£o ‚Üí üîµ Refatora√ß√£o
- **Dias 19-21**: üî¥ Testes hydration ‚Üí üü¢ Implementa√ß√£o ‚Üí üîµ Refatora√ß√£o
- **Quality Gate**: Coverage > 75% + Performance < 100ms

### Semana 5-6: Frontend Migration (TDD)
- **Dias 22-25**: üî¥ Testes componentes ‚Üí üü¢ Migra√ß√£o ‚Üí üîµ Refatora√ß√£o
- **Dias 26-28**: üî¥ Testes hooks ‚Üí üü¢ Implementa√ß√£o ‚Üí üîµ Refatora√ß√£o
- **Dias 29-31**: üî¥ Testes integra√ß√£o ‚Üí üü¢ E2E ‚Üí üîµ Otimiza√ß√£o
- **Quality Gate**: Coverage > 80% + Zero bugs cr√≠ticos

### Semana 7-8: Migra√ß√£o de Dados e Finaliza√ß√£o
- **Dias 32-35**: üî¥ Testes migra√ß√£o ‚Üí üü¢ Script ‚Üí üîµ Valida√ß√£o
- **Dias 36-38**: üî¥ Testes rollback ‚Üí üü¢ Implementa√ß√£o ‚Üí üîµ Documenta√ß√£o
- **Dias 39-42**: Otimiza√ß√µes finais e documenta√ß√£o
- **Quality Gate**: 100% dados migrados + Coverage > 85%

## üõ†Ô∏è COMANDOS ESPEC√çFICOS DO M√ìDULO

### Desenvolvimento TDD
```bash
# Executar testes espec√≠ficos do m√≥dulo
npm run test -- alimentacao --watch

# Coverage espec√≠fico
npm run test:coverage -- alimentacao

# Testes de performance
npm run test -- alimentacao --reporter=verbose

# Testes de integra√ß√£o
npm run test:integration -- alimentacao

# Executar apenas testes Red (falhantes)
npm run test -- alimentacao --reporter=verbose --bail

# Executar testes com timeout espec√≠fico
npm run test -- alimentacao --testTimeout=5000
```

### Quality Gates Autom√°ticos
```bash
# Verificar coverage threshold
npm run test:coverage -- alimentacao --threshold=75

# Executar pipeline completo
npm run ci:alimentacao

# Verificar performance
npm run test:perf -- alimentacao

# Validar contratos de API
npm run test:contract -- alimentacao
```

### Migra√ß√£o de Dados
```bash
# Backup dados localStorage
npm run migrate:backup -- alimentacao

# Executar migra√ß√£o
npm run migrate:run -- alimentacao

# Rollback se necess√°rio
npm run migrate:rollback -- alimentacao

# Validar migra√ß√£o
npm run migrate:validate -- alimentacao
```

---

**üìÖ Cronograma Total Estimado**: 6-8 semanas (incluindo TDD rigoroso)
**üîß Esfor√ßo T√©cnico**: Alto (devido ao TDD, mas com ROI comprovado)
**‚ö†Ô∏è Risco**: Baixo (infraestrutura FASE 0 + testes abrangentes)
**üë• Recursos**: 1 desenvolvedor full-stack + infraestrutura TDD pronta

---

## ‚úÖ CHECKLIST DE VALIDA√á√ÉO FINAL

### Prepara√ß√£o TDD (FASE 0 Integrada)
- [ ] ‚úÖ Infraestrutura Vitest + RTL + MSW configurada
- [ ] ‚úÖ Factories espec√≠ficas do m√≥dulo criadas
- [ ] ‚úÖ MSW handlers para todas as APIs implementados
- [ ] ‚úÖ Templates de teste documentados
- [ ] ‚úÖ Pipeline CI/CD espec√≠fico configurado

### Quality Gates por Fase
- [ ] ‚úÖ **Prepara√ß√£o**: Coverage > 70% + Setup 100% funcional
- [ ] ‚úÖ **APIs Core**: Coverage > 75% + Performance < 100ms
- [ ] ‚úÖ **Frontend**: Coverage > 80% + Zero bugs cr√≠ticos
- [ ] ‚úÖ **Migra√ß√£o**: 100% dados migrados + Rollback testado
- [ ] ‚úÖ **Finaliza√ß√£o**: Coverage > 85% + Documenta√ß√£o completa

### Testes Implementados
- [ ] ‚úÖ Testes unit√°rios para todos os componentes
- [ ] ‚úÖ Testes de hooks customizados
- [ ] ‚úÖ Testes de servi√ßos/APIs
- [ ] ‚úÖ Testes de integra√ß√£o E2E
- [ ] ‚úÖ Testes de migra√ß√£o de dados
- [ ] ‚úÖ Testes de rollback

### Documenta√ß√£o e Padr√µes
- [ ] ‚úÖ Templates de teste espec√≠ficos documentados
- [ ] ‚úÖ Factories reutiliz√°veis criadas
- [ ] ‚úÖ MSW handlers configurados
- [ ] ‚úÖ Comandos espec√≠ficos documentados
- [ ] ‚úÖ Cronograma TDD detalhado
- [ ] ‚úÖ M√©tricas de sucesso definidas

## üéì LI√á√ïES APRENDIDAS DA FASE 0 APLICADAS

### O Que Funcionou Bem (Replicado)
1. **Abordagem Incremental TDD** - Cada funcionalidade testada antes da implementa√ß√£o
2. **Quality Gates Autom√°ticos** - Preven√ß√£o de regress√µes em cada fase
3. **Documenta√ß√£o Paralela** - Templates e guias criados durante desenvolvimento
4. **Utilities Reutiliz√°veis** - Factories e helpers espec√≠ficos do m√≥dulo

### Melhorias Implementadas
1. **MSW Handlers Espec√≠ficos** - Cen√°rios de teste mais realistas para alimenta√ß√£o
2. **Cronograma TDD Detalhado** - Ciclos Red-Green-Refactor bem definidos
3. **M√©tricas Espec√≠ficas** - Targets adaptados para o dom√≠nio de alimenta√ß√£o
4. **Pipeline Modular** - CI/CD espec√≠fico para o m√≥dulo

### ROI Esperado (Baseado na FASE 0)
- **Desenvolvimento 50% mais r√°pido** ap√≥s curva de aprendizado
- **70% menos bugs em produ√ß√£o** devido aos testes abrangentes
- **80% mais r√°pido onboarding** de novos desenvolvedores
- **Infraestrutura paga investimento 5x** em 6 meses

---

**üèÜ STATUS**: ‚úÖ **PLANO REFATORADO COMPLETO - PRONTO PARA EXECU√á√ÉO**

*Este plano refatorado integra completamente a metodologia e infraestrutura TDD estabelecida na FASE 0, garantindo uma migra√ß√£o segura, testada e de alta qualidade para o m√≥dulo de alimenta√ß√£o, servindo como modelo para todos os demais m√≥dulos do StayFocus.*